[
    {
        "id": "7082cd4e.6f8ad4",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 550,
        "y": 160,
        "wires": [
            [
                "acc1de3b.5f557",
                "3f61d030.08f62",
                "f63b09da.125498",
                "877e2b13.97fc68",
                "c1d76272.5e2a5",
                "7498099d.b512b8"
            ]
        ]
    },
    {
        "id": "3bcea950.665596",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "STOP",
        "topic": "",
        "payload": "MDA-FINISH",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 410,
        "y": 580,
        "wires": [
            [
                "20f1ead8.5a6506",
                "5de57813.63b368"
            ]
        ]
    },
    {
        "id": "20f1ead8.5a6506",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "stop MDA time Order",
        "func": "if(msg.payload === 'MDA-FINISH'){\n    context.global.startMDA = 0 ;\n    node.status ({fill:\"red\",shape:\"dot\", text: \"STOP\"});\n    var msg = {} ;\n    msg.payload = \"STOP,\"+Date.now();\n    node.send(msg);\n}\nif(msg.payload === 'MDA-START'){\n    context.global.startMDA = 1 ;\n    node.status ({text: \"waiting stop ...\"});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 580,
        "wires": [
            [
                "f3a51aaf.51a2f8",
                "8a165cfd.54894"
            ]
        ]
    },
    {
        "id": "f63b09da.125498",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Initialisation",
        "func": "context.global.startMDA = 0 ;\n\ncontext.global.sync = 0 ;\ncontext.global.sync2 = 0 ;\ncontext.global.sync3 = 0 ;\ncontext.global.sync4 = 0 ;\n\ncontext.global.settingChannels = [];\ncontext.global.saveConfigChannel = '' ;\ncontext.global.saveConfigMda = '' ;\n\n\n\ncontext.global.camGrab = \"\";\ncontext.global.camGrabOld = \"\" ;\n\n//context.global.Fluorescence1 = 'CoolLed-PE4000';\n//context.global.listConfigChannel = ['williams1.json'] ;\n//context.global.initialize = false ;\n//context.global.ressources = [] ;\n\n//context.global.test = [];\n",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "82c0d0a8.91f12",
        "type": "http in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "url": "/missmarple",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 2200,
        "y": 1060,
        "wires": [
            [
                "10b0a409.b775ac"
            ]
        ]
    },
    {
        "id": "96146dc6.49096",
        "type": "http response",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "x": 2690,
        "y": 1060,
        "wires": []
    },
    {
        "id": "10b0a409.b775ac",
        "type": "template",
        "z": "cfcb4c03.e7a76",
        "name": "MissMarpleHTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->\n    <meta name=\"description\" content=\"\">\n    <meta name=\"author\" content=\"\">\n    <link rel=\"icon\" href=\"bootstrap/favicon.ico\">\n\n    <title>Miss Marple | Bootstrap</title>\n\n    <script>\n    </script>\n\n    <link href=\"bootstrap/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"bootstrap/assets/css/ie10-viewport-bug-workaround.css\" rel=\"stylesheet\">\n    <link href=\"bootstrap/dashboard.css\" rel=\"stylesheet\">\n    <link href=\"css/style1.css\" rel=\"stylesheet\">\n    <script src=\"bootstrap/assets/js/ie-emulation-modes-warning.js\"></script>\n    <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js\"></script>\n    <script src=\"js/js1.js\"></script>\n    \n    <script src=\"//code.jquery.com/jquery-3.3.1.min.js\"></script>\n    \n    <!-- This demo uses an 3rd-party, jQuery UI based context menu -->\n    <link href=\"//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css\" rel=\"stylesheet\">\n    <script src=\"//code.jquery.com/ui/1.12.1/jquery-ui.min.js\"></script>\n    <!-- jquery-contextmenu (https://github.com/mar10/jquery-ui-contextmenu/) -->\n    <script src=\"//cdn.jsdelivr.net/npm/ui-contextmenu/jquery.ui-contextmenu.min.js\"></script>\n    \n    <link href=\"fancytree-master/src/skin-win8/ui.fancytree.css\" rel=\"stylesheet\">\n    <script src=\"fancytree-master/src/jquery.fancytree.js\"></script>\n    <script src=\"fancytree-master/src/jquery.fancytree.dnd5.js\"></script>\n    <script src=\"fancytree-master/src/jquery.fancytree.edit.js\"></script>\n    <script src=\"fancytree-master/src/jquery.fancytree.gridnav.js\"></script>\n    <script src=\"fancytree-master/src/jquery.fancytree.table.js\"></script>\n    <script src=\"fancytree-master/src/jquery.fancytree.multi.js\"></script>\n    \n    <link rel=\"stylesheet\" href=\"//cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css\">\n    <script src=\"//cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js\"></script>\n  \n \n      \n    <style type=\"text/css\">\n      .ui-menu {\n        width: 200px;\n        height: 30px;\n        font-size: 63%;\n      }\n      .ui-menu kbd { /* Keyboard shortcuts for ui-contextmenu titles */\n        float: right;\n      }\n      /* custom alignment (set by 'renderColumns'' event) */\n      td.alignRight {\n         text-align: right;\n      }\n      td.alignCenter {\n         text-align: center;\n      }\n      td input[type=input] {\n        width: 40px;\n      }\n       span.drag-source {\n    border: 1px solid lightgray;\n    border-radius: 3px;\n    padding: 2px;\n    background-color: silver\n  }\n\n  ul.fancytree-container {\n    max-height: 200px;\n    overflow-y: scroll;\n  }\n\n  span.fancytree-node.fancytree-drag-source {\n    outline: 1px dotted grey;\n  }\n  span.fancytree-node.fancytree-drop-accept {\n    outline: 1px dotted green;\n  }\n  span.fancytree-node.fancytree-drop-reject {\n    outline: 1px dotted red;\n  }\n\n    </style>\n\n\n  </head>\n\n  <body  onload=\"wsConnect();\" onunload=\"ws.onclose();\">\n    \n     <div id=\"wait\" style=\"text-align: center;\" >\n        <img style=\"margin: 0 auto;\" src='media/Audit.png'><img style=\"margin: 0 auto;\" src='media/loading.gif'>\n        <br>\n        <h2>Loading parameters, please wait a few seconds</h2>\n     </div>\n    \n     <div id=\"main\">\n         <nav class=\"navbar navbar-inverse navbar-fixed-top\">\n          <div class=\"container-fluid\">\n            <div class=\"navbar-header\">\n              <button type=\"button\" class=\"navbar-toggle collapsed\" data-toggle=\"collapse\" data-target=\"#navbar\" aria-expanded=\"false\" aria-controls=\"navbar\">\n                <span class=\"sr-only\">Toggle navigation</span>\n                <span class=\"icon-bar\"></span>\n                <span class=\"icon-bar\"></span>\n                <span class=\"icon-bar\"></span>\n              </button>\n              <a class=\"navbar-brand\" href=\"#\"><img src=\"e475238aca49b9f6bb53cc4138fbdb27--funny-caricatures-celebrity-caricatures.jpg\" style=\"width: 40px; height: 50px\"></a>\n              <a class=\"navbar-brand\" href=\"#\">Miss Marple</a>\n              <a class=\"navbar-brand\" href=\"#\"><div id=\"status\"></div></a>\n              <a class=\"navbar-brand\" href=\"#\"><div id=\"name_user\"></div></a>\n            </div>\n            \n            <div id=\"navbar\" class=\"navbar-collapse collapse\">\n              <ul class=\"nav navbar-nav navbar-right\">\n                <li><a href=\"#\"><!--<img src=\"user.png\" style=\"width: 40px; height: 50px\">--></a></li>\n              </ul>\n            </div>\n          </div>\n        </nav>\n    \n    \n        <div class=\"container-fluid\">\n          <div class=\"row\">\n            <div class=\"col-sm-3 col-md-2 sidebar\">\n              <ul class=\"nav nav-sidebar\">\n                <li><a href=\"#\"></a></li>\n                <li id='livemodeli'><a href=\"javascript: live_mode();\">Live mode<span class=\"sr-only\" ></span></a></li>\n                <li id='settingschannelsli'><a href=\"javascript: setting();\">Settings Channels<span class=\"sr-only\"></span></a></li>\n                <li id='mdali'><a href=\"javascript: mda();\">MDA<span class=\"sr-only\" ></span></a></li>\n              </ul>\n            </div>\n            <div class=\"col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main\">    \n    \n            \n            <br>\n            <div id=\"receive\"></div>\n            <hr/>\n            <div id=\"alert-success\" class=\"alert alert-success\" role=\"alert\"></div>\n            <!--<div id=\"alert-warning\"  class=\"alert alert-warning\" role=\"alert\"></div>          -->\n\n          <div id=\"live_mode\">\n            <h2 class=\"sub-header\">Live mode</h2>\n<!--            -->\n            <div id=\"live_div\" class=\"table-responsive\">\n                <!--<span class=\"drag-source\" draggable=\"true\" id=\"live_olympusix81\"><img src='icons/OlympusIx81.png'>&nbsp;OLYMPUS-IX-81</span>-->\n                <img width='50%' height='50%' src='icons/work_in_progress.jpg'>\n            </div>    \n          </div>\n  \n          <div id=\"settings\">\n              <h2 class=\"sub-header\">Settings channels</h2>\n                <div id=\"name_configChannels\">\n                </div>\n                <div id=\"available_configChannels\">\n                </div>\n                <br>\n                <!--<button class='setting_button' alt='load channel' id=\"setting_button_load_channel\"><img src='icons/arrow_up.png'> Load a new setting channel configuration</button>-->\n                <button class='setting_button' alt='add channel' id=\"setting_button_add_channel\"><img src='icons/add.png'> Add a new setting channel</button>\n                <!--<button class='setting_button' alt='new configuration' id=\"setting_button_new_configChannel\"><img src='icons/add.png'> New configuration</button><br><br>-->\n                <div id='Enlightened'></div><br>\n                <form method=\"post\" id='setting_channel_form' action=\"/formpost\" ajax=\"true\">\n                      <!--<label hidden id='label_config'> Name: &nbsp;&nbsp;</label><input hidden required type='text' id='name_config' name=\"nam_config\" ><br>-->\n                      <div id=\"setting_table_channel\" class=\"table-responsive\"></div>\n                      <button type='submit' alt='save' class='setting_button' id='setting_button_save_channel'><img src='icons/disk.png'> Save the current settings</button>\n                </form>\n                <br>\n                <hr/>\n                \n<!--                Futur<br>\n                <button type='setting_button' alt='export setting' class='setting_button' id=\"setting_button_export_channel\"> Load</button>\n                <button type='setting_button' alt='import setting' class='setting_button' id=\"setting_button_import_channel\"> Save as</button>\n    -->             \n          </div>\n                \n          \n          <div id=\"mda\">\n            <h2 class=\"sub-header\">Multi-dimensional Acquisition</h2>\n                \n                <div id=\"name_configMda\">\n                </div>\n                <div id=\"available_configMda\">\n                </div>\n                <div id=\"available_channels_mda\">\n                </div>\n\n                <div id=\"available_ressources\">\n                    <span>Available resources and functions</span><br>\n                    <span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Simple picture');\"><img src='icons/camera.png'>&nbsp;Simple picture</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Autofocus');\"><img src='icons/autofocus.png'>&nbsp;Autofocus</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Z-stack');\"><img src='icons/zstack.png'>&nbsp;Z-stack</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'XYZ Position');\"><img src='icons/yxz-512.png'>&nbsp;XYZ-position</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Sequence');\"><img src='icons/arrow_rotate_clockwise.png'>&nbsp;Sequence</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Group Position');\"><img src='icons/plugin.png'>&nbsp;Group-position</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Mosaic');\"><img src='icons/mosaic.png'>&nbsp;Mosaic</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'End Mosaic');\"><img src='icons/nmosaic.png'>&nbsp;End Mosaic</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Slack message');\"><img src='icons/comments.png'>&nbsp;Slack message</span>\n                    &nbsp;<span class=\"drag-source\" draggable=\"true\" ondragstart=\"event.dataTransfer.setData('text/plain', 'Micro fluidic');\"><img src='icons/28-512.png'>&nbsp;Micro fluidic</span>\n                   \n             </div>\n                <h3>Definition of the experimental protocol</h3><hr/>\n\n                <table id=\"\" class=\"table table-striped\">\n                    <tbody>\n                        <tr>\n                            <th style=\"width:50%;\">                \n                                <!--<button class='' alt='load' id=\"\"><img src='icons/arrow_up.png'> Load a existing protocol</button>-->\n                                <button class='' alt='new' id=\"\"><img src='icons/add.png'> New protocol</button><br><br>\n                                <table id=\"tree\">\n                                    <colgroup>\n                                        <col width=\"1%\">\n                                        <col width=\"1%\">\n                                        <col width=\"38%\">\n                                        <col width=\"10%\">\n                                    </colgroup>\n                                    <thead>\n                                        <tr> <th></th> <th></th> <th></th> <th></th> <!--<th>Z-stacks</th> <th>Autofocus</th> <th>Save Images</th> <th>Comment</th> <th>Color</th>--> </tr>\n                                    </thead>\n                                    <tbody>\n                                      <tr>\n                                        <td class=\"alignCenter\"></td>\n                                        <td></td>\n                                        <td></td>\n                                        <td class=\"alignCenter\"></td>\n                                      </tr>\n                                    </tbody>\n                                </table>\n                            </th>\n                            <th style=\"width:50%;\">                \n                                <!--<label>PDMS chip:</label> <select><option>1</option><option>2</option></select><br>\n                                <img width=\"100%\" src='icons/test_uf.png'><br>\n                                <hr/>-->\n                                <button class='setting_button' alt='save' id='setting_button_save_configMda'><img src='icons/disk.png'>Save the protocol</button>\n                                <hr/>\n                                <p><big>Informations node function:</big><br><br> <span id=\"lblActive\">-</span></p>\n                                <hr/>\n                                <button onclick=test();>Start the protocol</button>\n                                <button  onclick=resetCOM();>reset communication with each device</button>\n                                \n                            </th>\n                        </tr>\n                    </tbody>\n                </table>\n  <!-- (Irrelevant source removed.) -->\n  \n  <script>\n  </script>\n\n            </div>\n            <!--</strong>-->\n            \n          </div>\n    \n              \n        </div>\n      </div>\n    </div>\n<!-- Bootstrap core JavaScript Placed at the end of the document so the pages load faster -->\n    <script>window.jQuery || document.write('<script src=\"bootstrap/assets/js/vendor/jquery.min.js\"><\\/script>')</script>\n    <script src=\"bootstrap/dist/js/bootstrap.min.js\"></script>\n    <script src=\"bootstrap/assets/js/vendor/holder.min.js\"></script>\n    <script src=\"bootstrap/assets/js/ie10-viewport-bug-workaround.js\"></script>\n    <script type=\"text/javascript\">\n    /*$.confirm({\n    title: 'WELCOME !',\n    theme: \"supervan\",\n    content: '' +\n    '<form action=\"\" class=\"formName\">' +\n    '<div class=\"form-group\">' +\n    '<label>Enter your name</label>' +\n    '<input type=\"text\" placeholder=\"Your name\" class=\"name form-control\" required />' +\n    '</div>' +\n    '</form>',\n    buttons: {\n        formSubmit: {\n            text: 'Submit',\n            btnClass: 'btn-blue',\n            action: function () {\n                var name = this.$content.find('.name').val();\n                if(!name){\n                    $.alert('provide a valid name');\n                    return false;\n                }\n                document.getElementById('name_user').innerHTML = \"USER:\"+name;\n                }\n        }\n    },\n    onContentReady: function () {\n        // bind to events\n        var jc = this;\n        this.$content.find('form').on('submit', function (e) {\n            // if the user submits the form by pressing enter in the field.\n            e.preventDefault();\n            jc.$$formSubmit.trigger('click'); // reference the button and click it\n        });\n    }\n});*/\ndocument.getElementById('name_user').innerHTML = \"UserName\";\n    </script>\n</body>\n</html>\n",
        "x": 2410,
        "y": 1060,
        "wires": [
            [
                "96146dc6.49096"
            ]
        ]
    },
    {
        "id": "4732506.aaec0b",
        "type": "http in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "url": "/formpost",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 2200,
        "y": 1020,
        "wires": [
            [
                "1f808817.668668"
            ]
        ]
    },
    {
        "id": "1f808817.668668",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "return msg.payload to client",
        "func": "var obj = msg.payload;\n\nif(obj['topicpost']==='setting_channel_form'){\n    context.global.settingChannels = [] ;\n    var index = '' ;                    \n    var old_index = '' ;\n    var indexation = -1 ;\n    var namechannel = '' ;\n    var oldlid = '';\n    var oldnid = '';\n    \n    for(var key in obj){\n        if(key !== 'topicpost'){\n            var str = key.split(\"_\");\n            index = str[0];\n            if(index != old_index){ indexation = indexation + 1 ; oldlid = '';}\n            old_index = parseInt(str[0]);    \n            if(key === (index + \"_channel\")){namechannel = obj[key];}\n            if(key === (index + \"_devices\")) {\n                context.global.settingChannels[indexation] = {};   \n                context.global.settingChannels[indexation]['id'] = indexation + 1;\n                context.global.settingChannels[indexation]['name'] = namechannel;\n                var obj2 = context.global.ressources[obj[key]] ;\n                for (var key2 in obj2) if(key!=='update')context.global.settingChannels[indexation][''+key2] = obj2[key2];\n                context.global.settingChannels[indexation]['update'] = {} ;\n            }\n            if((key !== (index + \"_channel\")) && (key !== (index + \"_devices\"))){    \n                var balise = str[1];\n                var lid = balise.substr(0,1) ; //a modifier expression régulière\n                var nid = parseInt(balise.substr(1,1)) ; //a modifier expression régulière\n                if (lid !== oldlid) context.global.settingChannels[indexation]['update'][lid] = [] ;\n                oldlid = lid ;\n                context.global.settingChannels[indexation]['update'][lid][nid] = obj[key]; // = obj[key];//settingChannel = name.concat(settingChannel);\n            }\n        }\n    }\n    //msg.payload = context.global.settingChannels;\n    msg.payload = 'The settings channels data was submitted and available';\n    return [msg];\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2440,
        "y": 1020,
        "wires": [
            [
                "96146dc6.49096",
                "8c85eb5e.01a268",
                "419c1ac4.6ee334"
            ]
        ]
    },
    {
        "id": "3dc2664d.25cada",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "get ? set ?",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\"=\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n  // expected output: ReferenceError: nonExistantFunction is not defined\n  // Note - error messages will vary depending on browser\n}\n\nif(order[0] === 'MDA-FINISH') msg.payload = 'MDA-FINISH' ;\nif(order[0] === 'getSettingChannels') msg.payload = context.global.settingChannels;\nif(order[0] === 'getSettingChannels2') msg.payload = context.global.settingChannels;\nif(order[0] === 'listConfigChannel') msg.payload = context.global.listConfigChannel;\nif(order[0] === 'listConfigMda') msg.payload = context.global.listConfigMda;\nif(order[0] === 'updateSettingChannels') msg.payload = context.global.settingChannels;\nif(order[0] === 'getSettingChannels-MDA') msg.payload = context.global.settingChannels;\nif(order[0] === 'getRessources') msg.payload = context.global.ressources;\n\nif(order[0] === 'getMDA-mdazs_zstart_set') msg.payload = \"123\";\n\nif(order[0] === 'setMDATimepointUse') context.global.mda['timepoints']['use'] = parseInt(order[1]) ;\nif(order[0] === 'setMDATimepointNumber') context.global.mda['timepoints']['number'] = parseInt(order[1]) ;\nif(order[0] === 'setMDATimepointInterval') context.global.mda['timepoints']['interval'] = parseInt(order[1]) ;\nif(order[0] === 'setMDATimepointUnity') context.global.mda['timepoints']['unity'] = (order[1]) ;\n\nif(order[0] === 'setMDAMultiplespositionsUse') context.global.mda['multiplespositions']['use'] = parseInt(order[1]) ;\n\nif(order[0] === 'setMDAZstacksUse') context.global.mda['zstacks']['use'] = parseInt(order[1]) ;\nif(order[0] === 'setMDAZstacksZstart') context.global.mda['zstacks']['zstart'] = parseInt(order[1]) ;\nif(order[0] === 'setMDAZstacksZend') context.global.mda['zstacks']['zend'] = parseInt(order[1]) ;\nif(order[0] === 'setMDAZstacksZstep') context.global.mda['zstacks']['zstep'] = parseInt(order[1]) ;\nif(order[0] === 'setMDAZstacksType') context.global.mda['zstacks']['type'] = (order[1]) ;\nif(order[0] === 'setMDAZstacksShutter') context.global.mda['zstacks']['shutteropen'] = parseInt(order[1]) ;\n\nif(order[0] === 'setMDAAutofocusUse') context.global.mda['autofocus']['use'] = parseInt(order[1]) ;\nif(order[0] === 'setMDAAutofocusSkip') context.global.mda['autofocus']['skip'] = parseInt(order[1]) ;\n\nif(order[0] === 'setMDAChannelsUse') context.global.mda['channels']['use'] = parseInt(order[1]) ;\nif(order[0] === 'setMDAChannelsConfiguration'){\n    var config = order[1].split(\",\");\n    var id = context.global.mda['channels']['config'].length;\n    context.global.mda['channels']['config'][id] = {} ;\n    context.global.mda['channels']['config'][id]['use'] = parseInt(config[0]);\n    context.global.mda['channels']['config'][id]['exposure'] = parseInt(config[1]);\n    context.global.mda['channels']['config'][id]['zoffset'] = parseInt(config[2]);\n    context.global.mda['channels']['config'][id]['channel'] = (config[3]);\n    context.global.mda['channels']['config'][id]['zstack'] = parseInt(config[4]);\n    context.global.mda['channels']['config'][id]['skipframe'] = parseInt(config[5]);\n    context.global.mda['channels']['config'][id]['refHTML'] = parseInt(config[6]);\n}\n\nif(order[0] === 'setMDAChannelsConfigurationUse'){\n    var config = order[1].split(\",\");\n    for(var i=0;i<context.global.mda['channels']['config'].length;i++){\n        if (parseInt(context.global.mda['channels']['config'][i]['refHTML']) === parseInt(config[1])){\n            context.global.mda['channels']['config'][i]['use'] = parseInt(config[0]);\n        }\n    }\n}\nif(order[0] === 'setMDAChannelsConfigurationExposure'){\n    var config = order[1].split(\",\");\n    for(var i=0;i<context.global.mda['channels']['config'].length;i++){\n        if (parseInt(context.global.mda['channels']['config'][i]['refHTML']) === parseInt(config[1])){\n            context.global.mda['channels']['config'][i]['exposure'] = parseInt(config[0]);\n        }\n    }\n}\nif(order[0] === 'setMDAChannelsConfigurationZoffset'){\n    var config = order[1].split(\",\");\n    for(var i=0;i<context.global.mda['channels']['config'].length;i++){\n        if (parseInt(context.global.mda['channels']['config'][i]['refHTML']) === parseInt(config[1])){\n            context.global.mda['channels']['config'][i]['zoffset'] = parseInt(config[0]);\n        }\n    }\n}\nif(order[0] === 'setMDAChannelsConfigurationChannel'){\n    var config = order[1].split(\",\");\n    for(var i=0;i<context.global.mda['channels']['config'].length;i++){\n        if (parseInt(context.global.mda['channels']['config'][i]['refHTML']) === parseInt(config[1])){\n            context.global.mda['channels']['config'][i]['channel'] = config[0];\n        }\n    }\n}\nif(order[0] === 'setMDAChannelsConfigurationZstack'){\n    var config = order[1].split(\",\");\n    for(var i=0;i<context.global.mda['channels']['config'].length;i++){\n        if (parseInt(context.global.mda['channels']['config'][i]['refHTML']) === parseInt(config[1])){\n            context.global.mda['channels']['config'][i]['zstack'] = parseInt(config[0]);\n        }\n    }\n}\nif(order[0] === 'setMDAChannelsConfigurationSkipframe'){\n    var config = order[1].split(\",\");\n    for(var i=0;i<context.global.mda['channels']['config'].length;i++){\n        if (parseInt(context.global.mda['channels']['config'][i]['refHTML']) === parseInt(config[1])){\n            context.global.mda['channels']['config'][i]['skipframe'] = parseInt(config[0]);\n        }\n    }\n}\nif(order[0] === 'MDAChannelsConfigurationRemove'){\n    for(var i=0;i<context.global.mda['channels']['config'].length;i++){\n        if (parseInt(context.global.mda['channels']['config'][i]['refHTML']) === parseInt(order[1])){\n            context.global.mda['channels']['config'].splice(i, 1);\n        }\n    }\n}\n\n\n\n\n\nif(order[0] === 'setMDASaveimagesUse') context.global.mda['saveimages']['use'] = parseInt(order[1]) ;\nif(order[0] === 'setMDASaveimagesDirectory') context.global.mda['saveimages']['directory'] = (order[1]) ;\nif(order[0] === 'setMDASaveimagesPrefix') context.global.mda['saveimages']['prefix'] = (order[1]) ;\nif(order[0] === 'setMDASaveimagesFormat') context.global.mda['saveimages']['format'] = (order[1]) ;\n\nif(order[0] === 'setMDAAcquisitioncommentComment') context.global.mda['acquisitioncomment'] = (order[1]) ;\n\n\nreturn msg ;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 2190,
        "y": 960,
        "wires": [
            [
                "8c85eb5e.01a268",
                "98c818c.0bedce8"
            ]
        ]
    },
    {
        "id": "8c85eb5e.01a268",
        "type": "websocket out",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "server": "a09da2d9.ae78a",
        "client": "",
        "x": 2740,
        "y": 960,
        "wires": []
    },
    {
        "id": "acc1de3b.5f557",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Object MDA",
        "func": "context.global.mda = {\n    \"timepoints\": {\n        \"use\" : 0,\n        \"number\" : 1,\n        \"interval\" : 1,\n        \"unity\" : \"ms\"\n    },\n    \"multiplespositions\": {\n        \"use\" : 0,\n        \"param\" : []\n    },\n    \"zstacks\": {\n        \"use\" : 0 ,\n        \"zstart\" : 0,\n        \"zend\" : 10,\n        \"zstep\" : 1,\n        \"type\" : \"relative Z\",\n        \"shutteropen\" : 0\n    },\n    \"autofocus\": {\n        \"use\" : 0,\n        \"skip\" : 0\n    },\n    \"channels\": {\n        \"use\" : 0,\n        \"config\" : []\n    },\n    \"saveimages\": {\n        \"use\" : 0,\n        \"directory\" : \"\",\n        \"prefix\" : \"\",\n        \"format\" : \"separate images files\"\n    },\n    \"acquisitioncomment\" : \"\"\n};\n",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "419c1ac4.6ee334",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "save settingChannels",
        "func": "var test = [\n  {\n      \"id\" : 0,\n      \"name\": \"channelA\",\n      \"device\" : \"CoolLed-PE-4000\",\n      \"type\" : \"ligth-source\",\n      \"topic\" : \"fluo1\",\n      \"update\" :{\n          \"A\" : [120,100,true],\n          \"B\" : [200,40,false],\n          \"C\" : [330,80,false],\n          \"D\" : [410,10,false]\n      },\n      \"config\":{\n          \"A\" : [\"<select name='0A0' id='0A0'><option name='0A00' id='0A00' value=100>100</option>          <option name='0A01' id='0A01' value=110>110</option>           <option name='0A02' id='0A02' selected value=120>120</option>   <option name='0A03' id='0A03' value=130>130</option></select>\",          \"<input name='0A1' id='0A1' type='number' min='0' max='100' step='1' value='100'/>\",    \"<input name='0A2'  id='0A2' checked type='checkbox'/>\"],\n          \"B\" : [\"<select name='0B0' id='0B0'><option name='0B00' id='0B00' selected value=200>200</option> <option name='0B01' id='0B01' value=210>210</option>           <option name='0B02' id='0B02' value=220>220</option>            <option name='0B03' id='0B03' value=230>230</option></select>\",          \"<input name='0B1' id='0B1' type='number' min='0' max='100' step='1' value='40'/>\",     \"<input name='0B2'  id='0B2' type='checkbox'/>\"],\n          \"C\" : [\"<select name='0C0' id='0C0'><option name='0C00' id='0C00' value=300>300</option>          <option name='0C01' id='0C01' value=310>310</option>           <option name='0C02' id='0C02' value=320>320</option>            <option name='0C03' id='0C03' selected value=330>330</option></select>\", \"<input name='0C1' id='0C1' type='number' min='0' max='100' step='1' value='80'/>\",     \"<input name='0C2'  id='0C2' type='checkbox'/>\"],\n          \"D\" : [\"<select name='0D0' id='0D0'><option name='0D00' id='0D00' value=400>400</option>          <option name='0D01' id='0D01' selected value=410>410</option>  <option name='0D02' id='tD02' value=420>420</option>            <option name='0D03' id='0D03' value=430>430</option></select>\",          \"<input name='0D1' id='0D1' type='number' min='0' max='100' step='1' value='10'/>\",     \"<input name='0D2'  id='0D2' type='checkbox'/>\"]\n        }\n  }\n ];\nmsg.payload =  test.concat(context.global.settingChannels);\n//msg.payload =  context.global.settingChannels;\nif(context.global.saveConfigChannel !== '' ) msg.filename = context.global.saveConfigChannel;\n\nreturn msg ;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 2740,
        "y": 1020,
        "wires": [
            [
                "a1335499.3c9a58"
            ]
        ]
    },
    {
        "id": "a1335499.3c9a58",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "x": 2910,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "95d4c4eb.6220c8",
        "type": "file in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 2310,
        "y": 880,
        "wires": [
            [
                "f30d878f.e10dc8"
            ]
        ]
    },
    {
        "id": "f30d878f.e10dc8",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "parseJSON",
        "func": "msg.payload = JSON.parse(msg.payload);\ncontext.global.settingChannels = msg.payload ;\n//msg.payload = context.global.settingChannels;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2450,
        "y": 880,
        "wires": [
            [
                "8c85eb5e.01a268"
            ]
        ]
    },
    {
        "id": "1d193af8.637c45",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "load",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\",\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\n\nif(order[0] === 'LoadSettingChannelsConfiguration') {\n    context.global.saveConfigChannel = 'C:/Users/labo/.node-red/lib2/config/'+context.global.listConfigChannel[parseInt(order[1])];\n    msg.filename = context.global.saveConfigChannel ;\n    return msg ;\n}\n\n\nif(order[0] === 'LoadSettingMda') {\n    context.global.saveConfigMda = 'C:/Users/labo/.node-red/lib2/mda/'+context.global.listConfigMda[parseInt(order[1])];\n    msg.filename = context.global.saveConfigMda ;\n    return msg ;\n}\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 2170,
        "y": 880,
        "wires": [
            [
                "95d4c4eb.6220c8"
            ]
        ]
    },
    {
        "id": "61e37720.8d9758",
        "type": "link out",
        "z": "cfcb4c03.e7a76",
        "name": "output_cam",
        "links": [
            "ba6d098d.7486f8",
            "66fdc750.1163a8",
            "f4307d4a.d18",
            "22a51e12.ba76a2"
        ],
        "x": 1475,
        "y": 660,
        "wires": []
    },
    {
        "id": "ba6d098d.7486f8",
        "type": "link in",
        "z": "cfcb4c03.e7a76",
        "name": "input_cam",
        "links": [
            "61e37720.8d9758"
        ],
        "x": 335,
        "y": 1020,
        "wires": [
            [
                "20f1ead8.5a6506",
                "5de57813.63b368",
                "97643878.87a698",
                "cff23c38.05aac",
                "15970796.a11128",
                "d9b7fa5c.49df48",
                "d377c06.1e99b4",
                "bfcffaa6.f55158",
                "6fbb0648.ee4338",
                "a2b9cf72.dd788"
            ]
        ]
    },
    {
        "id": "21d72bf5.9099e4",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "wait for all devices are initilized",
        "func": "function verifyIsTopicExists(ressources,topic){\n    if(ressources.length !==0){\n        var verify = false ;\n        for(var i=0; i<ressources.length;i++){\n            if(ressources[i]['topic']===topic){ verify = true ; return i;}\n        }\n        if(verify ===false) return (-1);\n    }\n    else return (-1) ;\n}\n\n\nif(msg.mode === 'init'){\n    \n    context.data = context.data || new Object();\n    context.global.ressources = context.global.ressources || [];\n    \n    var verify = verifyIsTopicExists(context.global.ressources,msg.topic) ;\n    \n    switch (msg.topic) {\n        case \"Fluorescence1\":\n            context.data.task1 = msg.device;\n            context.global.Fluorescence1 = msg.device ;\n            if(verify === -1) context.global.ressources.push(msg);\n            else  context.global.ressources[verify] = msg ;\n            msg = null;\n            break;\n        case \"MotionStage1\":\n            context.data.task2 = msg.device;\n            context.global.MotionStage1 = msg.device ;\n            if(verify === -1) context.global.ressources.push(msg);\n            else  context.global.ressources[verify] = msg ;\n            msg = null;\n            break;\n        case \"Microscope1\":\n            context.data.task3 = msg.device;\n            context.global.Microscope1 = msg.device ;\n            if(verify === -1) context.global.ressources.push(msg);\n            else  context.global.ressources[verify] = msg ;\n            msg = null;\n            break;\n        /*case \"Mosaic1\":\n            context.data.task4 = msg.device;\n            context.global.Mosaic1 = msg.device ;\n            if(verify === -1) context.global.ressources.push(msg);\n            else  context.global.ressources[verify] = msg ;\n            msg = null;\n            break;*/\n        case \"Camera1\":\n            context.data.task5 = msg.device;\n            context.global.Camera1 = msg.device ;\n            if(verify === -1) context.global.ressources.push(msg);\n            else  context.global.ressources[verify] = msg ;\n            msg = null;\n            break;\n        case \"Fluorescence2\":\n            context.data.task6 = msg.device;\n            context.global.Fluorescence2 = msg.device ;\n            if(verify === -1) context.global.ressources.push(msg);\n            else  context.global.ressources[verify] = msg ;\n            msg = null;\n            break;\n        default:\n            msg = null;\n        \tbreak;\n    \n    }\n    \n    if(context.data.task1 != null && context.data.task2 != null && context.data.task3 != null && context.data.task6 != null ){//&& context.data.task4 != null && context.data.task5 != null && context.data.task6 != null) {\n    \tmsg2 = new Object();\n        msg2 = context.data;\n        msg2.payload = \"Initialisation >>> DONE :-)\";\n        context.global.initialize = true ;\n        context.data=null;\n    \treturn msg2;\n    } else return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1310,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "90cbd165.e10b6",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "live",
        "func": "msg.payload =  context.global.Mosaic1;\nmsg.topic = 'Mosaic1';\nmsg.device =  context.global.Mosaic1;\nmsg.mode = 'live';\nmsg.update = {\n  \"matrice\" : 2324\n}    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3730,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "c221f90f.844d88",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3600,
        "y": 1000,
        "wires": [
            [
                "90cbd165.e10b6"
            ]
        ]
    },
    {
        "id": "8f18a9bc.563878",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "live",
        "func": "msg.payload =  context.global.Fluorescence2;\nmsg.topic = 'Fluorescence2';\nmsg.device =  context.global.Fluorescence2;\nmsg.mode = 'live';\nmsg.action = 'set' ;\nmsg.update = {\n  \"shutter\" : true,\n  \"intensity\" : 40\n}    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3730,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "9ffe9c.4c712168",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3600,
        "y": 960,
        "wires": [
            [
                "8f18a9bc.563878"
            ]
        ]
    },
    {
        "id": "3f61d030.08f62",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Object sequencer 2",
        "func": "/*context.global.sequence2 = {\n    \"0\" : \n        [\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : context.global.Fluorescence1,\n            'mode' : 'MDA',\n            \"update\" :\n                {\n                \"A\" : [120,100,\"ON\"],\n                \"B\" : [200,100,\"ON\"],\n                \"C\" : [330,100,\"ON\"],\n                \"D\" : [410,100,\"ON\"]\n                }    \n            },\n            {\n            'topic' : 'MotionStage1',\n            'device' : context.global.MotionStage1,\n            'action' : 'set',\n            'mode' : 'MDA',\n            'x': 100,\n            'y': 100,\n            'fonction': 'moveToPositionXY'    \n            }],\n            [{\n                'topic' : 'Camera1',\n                'device' : context.global.Camera1,\n                'mode' : 'MDA',\n                'exposure': 20,\n                'fonction' : 'getFrame'\n            }],\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : context.global.Fluorescence1,\n            'mode' : 'MDA',\n            \"update\" :\n                {\n                \"A\" : [120,100,\"ON\"],\n                \"B\" : [200,100,\"ON\"],\n                \"C\" : [330,100,\"ON\"],\n                \"D\" : [410,100,\"ON\"]\n                }    \n            },\n            {\n            'topic' : 'MotionStage1',\n            'device' : context.global.MotionStage1,\n            'mode' : 'MDA',\n            'action' : 'setAll',\n            'x': 1365,\n            'y': 3420,\n            'fonction': 'moveToPositionXY'    \n            }],\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : context.global.Fluorescence1,\n            'mode' : 'MDA',\n            \"update\" :\n                {\n                \"A\" : [120,100,\"ON\"],\n                \"B\" : [200,100,\"ON\"],\n                \"C\" : [330,100,\"ON\"],\n                \"D\" : [410,100,\"ON\"]\n                }    \n            },\n            {\n            'topic' : 'MotionStage1',\n            'device' : context.global.MotionStage1,\n            'mode' : 'MDA',\n            'action' : 'setAll',\n            'x': 1365,\n            'y': 3420,\n            'fonction': 'moveToPositionXY'    \n            }]\n        ],\n    \"10\" : \n        [\n            [{\n            'topic' : 'Camera1',\n            'device' : context.global.Camera1,\n            'mode' : 'MDA',\n            'exposure': 200,\n            'fonction' : 'getFrame'\n            }],\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : context.global.Fluorescence1,\n            'mode' : 'MDA',\n            \"update\" :\n                {\n                \"A\" : [120,100,\"ON\"],\n                \"B\" : [200,100,\"ON\"],\n                \"C\" : [330,100,\"ON\"],\n                \"D\" : [410,100,\"ON\"]\n                }    \n            },\n            {\n            'topic' : 'MotionStage1',\n            'device' : context.global.MotionStage1,\n            'mode' : 'MDA',\n            'action' : 'setAll',\n            'x': 1365,\n            'y': 3420,\n            'fonction': 'moveToPositionXY'    \n            }]\n        ],\n    \"20\" : \n        [{\n        'topic' : 'MotionStage1',\n        'device' : context.global.MotionStage1,\n        'mode' : 'MDA',\n        'action' : 'setAll',\n        'x': 1365,\n        'y': 3420,\n        'fonction': 'moveToPositionXY'\n        }],\n    \"40\" : \n        [\n            [{\n            'topic' : 'Camera1',\n            'device' : context.global.Camera1,\n            'mode' : 'MDA',\n            'exposure': 20,\n            'fonction' : 'getFrame'\n            }],\n            [{\n            'payload' : 'MDA-FINISH',\n            }]\n        ]\n}*/\n\n\ncontext.global.sequence2 = {\n    \"0\" : \n        [\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : 'CoolLed-PE4000',\n            'mode' : 'MDA',\n            'action' : 'set',\n            \"update\" :\n                {\n                \"A\" : [435,70,true],\n                \"B\" : [470,100,true],\n                \"C\" : [580,100,true],\n                \"D\" : [660,100,true]\n                }    \n            },\n            {\n            'topic' : 'MotionStage1',\n            'device' : 'PRIOR-PRO-SCAN',\n            'action' : 'set',\n            'mode' : 'MDA',\n            'update' : {\n                'xPosition': 10000,\n                'yPosition': 10000,\n                'moveType': 'GR'    \n                }\n            }],\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : 'CoolLed-PE4000',\n            'mode' : 'MDA',\n            'action' : 'set',\n            \"update\" :\n                {\n                \"A\" : [435,100,true],\n                \"B\" : [470,2,false],\n                \"C\" : [580,100,true],\n                \"D\" : [660,2,false]\n                }    \n            }]\n        ],\n    \"10\" : \n        [\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : 'CoolLed-PE4000',\n            'mode' : 'MDA',\n            'action' : 'set',\n            \"update\" :\n                {\n                \"A\" : [435,100,false],\n                \"B\" : [470,100,false],\n                \"C\" : [580,100,false],\n                \"D\" : [660,100,false]\n                }    \n            }\n            ]\n        ],\n    \"20\" : \n        [\n            [{\n            'topic' : 'Fluorescence1',\n            'device' : 'CoolLed-PE4000',\n            'mode' : 'MDA',\n            'action' : 'set',\n            \"update\" :\n                {\n                \"A\" : [435,100,true],\n                \"B\" : [470,100,true],\n                \"C\" : [580,100,true],\n                \"D\" : [660,100,true]\n                }    \n            },\n            {\n            'topic' : 'MotionStage1',\n            'device' : 'PRIOR-PRO-SCAN',\n            'action' : 'set',\n            'mode' : 'MDA',\n            'update' : {\n                'xPosition': 2000,\n                'yPosition': 2000,\n                'moveType': 'GR'    \n                }\n            }]\n        ],\n    \"30\" : \n        [\n            [{\n                'topic' : 'MotionStage1',\n            'device' : 'PRIOR-PRO-SCAN',\n            'action' : 'set',\n            'mode' : 'MDA',\n            'update' : {\n                'xPosition': 0,\n                'yPosition': 0,\n                'moveType': 'G'    \n                }\n            }],\n            [{\n            'payload' : 'MDA-FINISH',\n            }]\n        ]\n    }",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "6be44e13.6e89f",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Sequencer 2 Miss Marple - MDA",
        "func": "    \n    node.status ({fill:\"green\",shape:\"dot\", text: \"request\"});\n    \n    if( (context.global.startMDA === 1) && (context.global.initialize === true)){\n        node.status ({fill:\"yellow\",shape:\"dot\", text: context.global.sync2+\"-\"+context.global.sync3});\n        var lengt = context.global.sequence2[context.global.sync2].length ;\n        if( lengt  !== context.global.sync3 ){\n        \n            var order = context.global.sequence2[context.global.sync2];\n        \n            if(msg.payload === 'done'){\n        //\n        //\n        //\n                context.global.checkFinish = context.global.checkFinish + 1 ;\n        \n                node.status ({fill:\"yellow\",shape:\"dot\", text: context.global.sync2+\"-\"+context.global.sync3+\" - \"+context.global.finish+\"-\"+context.global.checkFinish});\n            \n        \n                if(context.global.checkFinish === context.global.finish){\n                    context.global.checkFinish = 0 ;\n                    if(order[context.global.sync3][0].action !== '_waiting_'){\n                            if(order.length !==1) {\n                            context.global.finish = order[context.global.sync3].length ; // nombre d'instructions dans la branche la plus profonde de l'object sequencer\n                            for(var i=0;i<order[context.global.sync3].length;i++){ node.send(order[context.global.sync3][i]);}\n                            //if(order[context.global.sync3][i]['payload'] === 'MDA-FINISH') node.status ({fill:\"red\",shape:\"dot\", text: \"finished and waiting order ...\"});\n            //                node.warn(\"ZFZ\");\n                        }\n                        else{ \n                            node.send(order[context.global.sync3]) ;\n                            context.global.finish = 1 ;\n            //                node.warn(\"ZZZ\");\n                        }\n                        context.global.sync3 = context.global.sync3 + 1 ;\n                    } else context.global.sync3 = context.global.sync3 + 1 ;\n                } \n            }\n            else{//start mda trigger\n                if(order[context.global.sync3][0].action !== '_waiting_'){\n                    if(order.length !==1) {\n                        context.global.finish = order[context.global.sync3].length ; // nombre d'instructions dans la branche la plus profonde de l'object sequencer\n                        for(var i=0;i<order[context.global.sync3].length;i++){ node.send(order[context.global.sync3][i]);}\n                    }\n                    else { \n                        context.global.finish = 1 ;\n                        node.send(order[context.global.sync3]) ;\n                    }\n                    context.global.sync3 = context.global.sync3 + 1 ;\n                }else context.global.sync3 = context.global.sync3 + 1 ;\n            }\n        }\n    } \n",
        "outputs": 1,
        "noerr": 0,
        "x": 1310,
        "y": 660,
        "wires": [
            [
                "61e37720.8d9758"
            ]
        ]
    },
    {
        "id": "5de57813.63b368",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "start MDA time Order",
        "func": "if(msg.payload === 'MDA-START'){\n    context.global.startMDA = 1 ;\n    context.global.checkFinish = 0 ;\n    global.set('scanTime',0);\n    context.global.sync2 = (0);\n    context.global.sync3 = 0;\n    msg.payload = context.global.sequence2[String(0)];\n    node.send(msg);\n    node.status ({fill:\"green\",shape:\"dot\", text: \"START: timeOrder@0min\"});\n    var mdaSync = setInterval(function(){\n        scanTime = global.get('scanTime') + 1;\n        global.set('scanTime',scanTime);\n        for(var key in context.global.sequence2){\n            if(key===String(scanTime)){\n                context.global.sync2 = key;\n                msg.payload = context.global.sequence2[key];\n                context.global.sync3 = 0;\n                node.send(msg);\n                node.status ({fill:\"green\",shape:\"dot\", text: \"START: timeOrder@\"+scanTime+\"min\"});\n            }\n        }\n    },60000);\n    global.set('mdaSync',mdaSync);\n    \n}\nif(msg.payload === 'MDA-FINISH'){\n    context.global.startMDA = 0 ;\n    node.status ({text: \"waiting start ...\"});\n    clearTimeout(global.get('mdaSync'));\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 540,
        "wires": [
            [
                "6be44e13.6e89f"
            ]
        ]
    },
    {
        "id": "6aca7cba.2bd8d4",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "START",
        "topic": "",
        "payload": "MDA-START",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 410,
        "y": 540,
        "wires": [
            [
                "5de57813.63b368",
                "20f1ead8.5a6506",
                "646a577e.9a0c78"
            ]
        ]
    },
    {
        "id": "4e4c84f3.78eb1c",
        "type": "websocket in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "server": "a09da2d9.ae78a",
        "client": "",
        "x": 1910,
        "y": 680,
        "wires": [
            [
                "2de1b613.a0d65a",
                "c44d817.893c78",
                "225e50bc.23024",
                "1d193af8.637c45",
                "4cfe5530.7e20cc",
                "d37e8f15.20f5e",
                "d22feb0f.8445b8",
                "3dc2664d.25cada",
                "2fd93f42.deda7",
                "c740fa51.07fe08"
            ]
        ]
    },
    {
        "id": "2de1b613.a0d65a",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "fancyTree switch",
        "func": "context.global.sendDataLive = {} ;\nvar order = [] ;\ntry {\n  order = msg.payload.split(\",\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\ncontext.global.fancyTreeOrder = order[0] ;\nvar output = {} ;\n\nfunction posWheel(wh){\n    setTimeout(function(){\n       node.warn('posWheel');\n        output = {} ;\n        output.payload =  context.global.Microscope1;\n        output.topic = 'Microscope1';\n        output.device =  context.global.Microscope1;\n        output.mode = 'live';\n        output.action = 'setWheelFilter';\n        output.update = {};\n        output.update = {'wheelFilter' : parseInt(wh)};\n        node.send(output);\n    },2000);\n}\nif(order[0] === 'resetCOM'){\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'reset';\n    node.send(output);\n}\n\nif(order[0] === 'getValueXYZ'){\n    context.global.sendDataLiveLg = 12 ;\n    output.payload =  context.global.MotionStage1;\n    output.topic = 'MotionStage1';\n    output.device =  context.global.MotionStage1;\n    output.mode = 'live';\n    output.action = 'get';\n    node.send(output);\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'getZPosition';\n    node.send(output);\n}\n\nif(order[0] === 'getValueZ'){\n    context.global.sendDataLiveLg = 10 ;\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'getZPosition';\n    node.send(output);\n}\n\nif(order[0] === 'tryAutoFocus'){\n    context.global.sendDataLiveLg = 13;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'af';\n    output.update = {\n        \"farLimit\" : 1,\n        \"nearLimit\" : 3000000,\n        \"affLimit\": parseInt(order[1])-(100*parseInt(order[2])),\n        \"afnLimit\":parseInt(order[1])+(100*parseInt(order[3])),\n        \"objective\":parseInt(order[4]),\n        \"offset\" : parseInt(order[5])\n    }\n    node.send(output);\n}\n\nif(order[0] === 'moveX'){\n    context.global.sendDataLiveLg = 3 ;\n    output.payload =  context.global.MotionStage1;\n    output.topic = 'MotionStage1';\n    output.device =  context.global.MotionStage1;\n    output.mode = 'live';\n    output.action = 'set';\n    output.update = {} ;\n    output.update = {\n        \"xPosition\" : 0,\n        \"yPosition\" : parseInt(order[2]) * (order[1] ==\"UP\" ? 1 : -1),\n        \"moveType\" : \"GR\"\n    } ;\n    node.send(output);\n}\n\nif(order[0] === 'moveY'){\n    context.global.sendDataLiveLg = 3 ;\n    output.payload =  context.global.MotionStage1;\n    output.topic = 'MotionStage1';\n    output.device =  context.global.MotionStage1;\n    output.mode = 'live';\n    output.action = 'set';\n    output.update = {} ;\n    output.update = {\n        \"xPosition\" : parseInt(order[2]) * (order[1] ==\"RG\" ? 1 : -1)  ,\n        \"yPosition\" : 0,\n        \"moveType\" : \"GR\"\n    } ;\n    node.send(output);\n}\n\nif(order[0] === 'moveZ'){\n    //context.global.sendDataLiveLg = 9 ;\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'setZPosition';\n    output.update = {\n        \"zPosition\" : parseInt(order[2]),\n        \"moveType\": order[1]\n    };\n    node.send(output);\n}\n\nif(order[0] === 'goToPosition'){\n    //context.global.sendDataLiveLg = 3 ;\n    output.payload =  context.global.MotionStage1;\n    output.topic = 'MotionStage1';\n    output.device =  context.global.MotionStage1;\n    output.mode = 'live';\n    output.action = 'set';\n    output.update = {} ;\n    output.update = {\n        \"xPosition\" : parseInt(order[1]),\n        \"yPosition\" : parseInt(order[2]),\n        \"moveType\" : \"G\"\n    } ;\n    node.send(output);\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'setZPosition';\n    output.update = {\n        \"zPosition\" : parseInt(order[3]),\n        \"moveType\": \"d\"\n    };\n    node.send(output);\n}\n\nif(order[0] === 'posLigth'){\n  setTimeout(function(){\n    var olympus = false ;\n    var coolled = false ;\n    var xcite = false ;\n\n\n        if(order[1] === -1 ){\n            output = {} ;\n            output.payload =  context.global.Fluorescence1;\n            output.topic = 'Fluorescence1';\n            output.device =  context.global.Fluorescence1;\n            output.mode = 'live';\n            output.action = 'setOFF';\n            node.send(output);\n            output = {} ;\n            output.payload =  context.global.Microscope1;\n            output.topic = 'Microscope1';\n            output.device =  context.global.Microscope1;\n            output.mode = 'live';\n            output.action = 'setOFF';\n            node.send(output);\n            output = {} ;\n            output.payload =  context.global.Fluorescence2;\n            output.topic = 'Fluorescence2';\n            output.device =  context.global.Fluorescence2;\n            output.mode = 'live';\n            output.action = 'setOFF';\n            node.send(output);\n            \n        }else {\n        for(var i=1 ; i<context.global.settingChannels.length; i++){\n           \n            \n            if(i === parseInt(order[1])){\n                node.warn(i+\",\"+parseInt(order[1]));\n                if((context.global.settingChannels[i]['device'] === 'OLYMPUS-IX-81')){\n                    olympus = true ;\n                    output = {} ;\n                    output.payload =  context.global.Microscope1;\n                    output.topic = 'Microscope1';\n                    output.device =  context.global.Microscope1;\n                    output.mode = 'live';\n                    output.action = 'setChannel';\n                    output.update = {\n                        \"lamp\" : true ,\n                        \"intensity\": context.global.settingChannels[i]['update']['A'][0] ,\n                        \"shutter\": true ,\n                        \"timeout\" : -1\n                        };\n                  \n                        node.send(output);\n                       posWheel(context.global.settingChannels[i]['update']['C'][0]);\n              \n                }\n                \n                if((context.global.settingChannels[i]['device'] === 'CoolLed-PE4000')){\n                    coolled = true ;\n                    output = {} ;\n                    output.payload =  context.global.Fluorescence1;\n                    output.topic = 'Fluorescence1';\n                    output.device =  context.global.Fluorescence1;\n                    output.mode = 'live';\n                    output.action = 'set';\n                    output.update = {\n                        \"A\" : [context.global.settingChannels[i]['update']['A'][0],context.global.settingChannels[i]['update']['A'][1],context.global.settingChannels[i]['update']['A'][2] == \"OFF\" ? false : true] ,\n                        \"B\" : [context.global.settingChannels[i]['update']['B'][0],context.global.settingChannels[i]['update']['B'][1],context.global.settingChannels[i]['update']['B'][2] == \"OFF\" ? false : true] ,\n                        \"C\" : [context.global.settingChannels[i]['update']['C'][0],context.global.settingChannels[i]['update']['C'][1],context.global.settingChannels[i]['update']['C'][2] == \"OFF\" ? false : true] ,\n                        \"D\" : [context.global.settingChannels[i]['update']['D'][0],context.global.settingChannels[i]['update']['D'][1],context.global.settingChannels[i]['update']['D'][2] == \"OFF\" ? false : true] ,\n                        \"timeout\" : -1\n                    };\n                    node.send(output);\n                   posWheel(context.global.settingChannels[i]['update']['F'][0]);\n\n                }\n                if((context.global.settingChannels[i]['device'] === 'X-Cite-120PC')){\n                    xcite = true ;\n                    output = {} ;\n                    output.payload =  context.global.Fluorescence2;\n                    output.topic = 'Fluorescence2';\n                    output.device =  context.global.Fluorescence2;\n                    output.mode = 'live';\n                    output.action = 'setChannel';\n                    output.update = {\n                        \"A\" : [parseFloat(context.global.settingChannels[i]['update']['A'][0]),true]\n                    };\n                    node.send(output);\n                    posWheel(context.global.settingChannels[i]['update']['C'][0]);\n\n                }\n            }\n            else {\n                if((context.global.settingChannels[i]['device'] === 'CoolLed-PE4000')&&(coolled === false)){\n                    //coolled = true ;\n                    output = {} ;\n                    output.payload =  context.global.Fluorescence1;\n                    output.topic = 'Fluorescence1';\n                    output.device =  context.global.Fluorescence1;\n                    output.mode = 'live';\n                    output.action = 'setOFF';\n                    node.send(output);\n                }\n                if((context.global.settingChannels[i]['device'] === 'OLYMPUS-IX-81')&&(olympus === false)){\n                    //olympus = true ;\n                    output = {} ;\n                    output.payload =  context.global.Microscope1;\n                    output.topic = 'Microscope1';\n                    output.device =  context.global.Microscope1;\n                    output.mode = 'live';\n                    output.action = 'setOFF';\n                    node.send(output);\n                }\n                if((context.global.settingChannels[i]['device'] === 'X-Cite-120PC')&&(xcite === false)){\n                    //olympus = true ;\n                    output = {} ;\n                    output.payload =  context.global.Fluorescence2;\n                    output.topic = 'Fluorescence2';\n                    output.device =  context.global.Fluorescence2;\n                    output.mode = 'live';\n                    output.action = 'setOFF';\n                    node.send(output);\n                }\n                \n            }\n        }}\n    },500);\n}\n\nif(order[0] === 'EnlightenedOFF'){\n    output = {} ;\n    output.payload =  context.global.Fluorescence1;\n    output.topic = 'Fluorescence1';\n    output.device =  context.global.Fluorescence1;\n    output.mode = 'live';\n    output.action = 'setOFF';\n    node.send(output);\n    \n     output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'setOFF';\n    node.send(output);\n    \n         output = {} ;\n    output.payload =  context.global.Fluorescence2;\n    output.topic = 'Fluorescence2';\n    output.device =  context.global.Fluorescence2;\n    output.mode = 'live';\n    output.action = 'setOFF';\n    node.send(output);\n    \n}\n\nif(order[0] === 'updatefilter'){\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'setWheelFilter';\n    output.update = {\n        \"wheelFilter\" : order[1]\n    }\n    node.send(output);\n}\nif(order[0] === 'getAutofocus'){\n    context.global.sendDataLiveLg = 10 ;\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'get';\n    node.send(output);\n}\nif(order[0] === 'posWheel'){\n    output = {} ;\n    output.payload =  context.global.Microscope1;\n    output.topic = 'Microscope1';\n    output.device =  context.global.Microscope1;\n    output.mode = 'live';\n    output.action = 'setWheelFilter';\n    output.update = {'wheelFilter' : parseInt(order[1])};\n    node.send(output);\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 2210,
        "y": 680,
        "wires": [
            [
                "5290f15b.3e802"
            ]
        ]
    },
    {
        "id": "cc9c7d5e.96604",
        "type": "websocket out",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "server": "a09da2d9.ae78a",
        "client": "",
        "x": 1460,
        "y": 940,
        "wires": []
    },
    {
        "id": "cb926656.1428b8",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "if mode === live",
        "func": "\n    if(msg.mode === 'live'){\n\n        if((context.global.fancyTreeOrder === 'getValueXYZ')||(context.global.fancyTreeOrder === 'getValueZ')||(context.global.fancyTreeOrder === 'tryAutoFocus')||(context.global.fancyTreeOrder === 'getAutofocus')){\n        \n            if(msg.topic === 'Microscope1') {\n                for(var key in msg.update['A']){\n                    context.global.sendDataLive[key] = msg.update['A'][key];\n                }\n                if(context.global.fancyTreeOrder === 'tryAutoFocus'){\n                    for(var key in msg.status){\n                    context.global.sendDataLive[key] = msg.status[key];\n                     }\n                }\n            }\n            else{\n                for(var key in msg.update){\n                    context.global.sendDataLive[key] = msg.update[key];\n                }\n            }\n                //var msg={};\n            node.warn(Object.keys(context.global.sendDataLive).length);\n            //msg.payload = context.global.fancyTreeOrder+\"-\"+context.global.sendDataLiveLg+\"-\"+Object.keys(context.global.sendDataLive).length;\n            node.send(msg);\n            if(Object.keys(context.global.sendDataLive).length === context.global.sendDataLiveLg){\n                var msg = {};\n                msg.payload = context.global.sendDataLive ;\n                node.send(msg);\n                context.global.sendDataLive = {} ;\n                context.global.fancyTreeOrder = \"\";\n            } \n        }\n    }",
        "outputs": 1,
        "noerr": 0,
        "x": 1260,
        "y": 940,
        "wires": [
            [
                "cc9c7d5e.96604"
            ]
        ]
    },
    {
        "id": "c44d817.893c78",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "create config channel",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\",\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\nvar output = {} ;\nif(order[0] === 'configChannels'){\n    context.global.saveConfigChannel = 'C:/Users/labo/.node-red/lib2/config/'+order[1]+\".json\" ;\n    output.filename =  context.global.saveConfigChannel;\n    output.payload =  \"create\";\n    context.global.listConfigChannel.push(order[1]+\".json\");\n    node.send(output);\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2220,
        "y": 720,
        "wires": [
            [
                "6e5a0403.91a44c"
            ]
        ]
    },
    {
        "id": "6e5a0403.91a44c",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "x": 2690,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "877e2b13.97fc68",
        "type": "file in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "C:\\Users\\labo\\.node-red\\lib2\\config\\list.txt",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 840,
        "y": 220,
        "wires": [
            [
                "f882f423.54dc08"
            ]
        ]
    },
    {
        "id": "f882f423.54dc08",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Initialisation",
        "func": "context.global.listConfigChannel = msg.payload.split(\";\");\n//context.global.initialize = false ;\n//context.global.ressources = [] ;\n\n//context.global.test = [];\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1230,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "225e50bc.23024",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "extend config channel",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\",\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\nvar output = {} ;\nif(order[0] === 'configChannels'){\n    output.payload = \";\"+order[1]+\".json\";\n    node.send(output);\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2220,
        "y": 760,
        "wires": [
            [
                "1473a39e.4a611c"
            ]
        ]
    },
    {
        "id": "1473a39e.4a611c",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "C:\\Users\\labo\\.node-red\\lib2\\config\\list.txt",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "false",
        "x": 2580,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "97643878.87a698",
        "type": "PriorProScan",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "x": 770,
        "y": 880,
        "wires": [
            [
                "6be44e13.6e89f",
                "21d72bf5.9099e4",
                "cb926656.1428b8"
            ]
        ]
    },
    {
        "id": "1b89a54.8841a5b",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "live",
        "func": "msg.payload =  context.global.Fluorescence2;\nmsg.topic = 'Fluorescence2';\nmsg.device =  context.global.Fluorescence2;\nmsg.mode = 'live';\nmsg.action = 'set' ;\nmsg.update = {\n  \"shutter\" : false,\n  \"intensity\" : 40\n}    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3730,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "73e5324.be366cc",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3600,
        "y": 920,
        "wires": [
            [
                "1b89a54.8841a5b"
            ]
        ]
    },
    {
        "id": "d326cbab.6cdc68",
        "type": "json",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 2310,
        "y": 920,
        "wires": [
            [
                "6d39b39b.11964c"
            ]
        ]
    },
    {
        "id": "cff23c38.05aac",
        "type": "CoolLedPe4000",
        "z": "cfcb4c03.e7a76",
        "name": "PE4000",
        "topic": "drive the PE-4000",
        "x": 760,
        "y": 940,
        "wires": [
            [
                "6be44e13.6e89f",
                "21d72bf5.9099e4",
                "cb926656.1428b8"
            ]
        ]
    },
    {
        "id": "10be0019.c535b",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Camera rec.",
        "func": "if(msg.payload !== 'STOP'){\n    var data = [] ;\n    t = 0 ;\n    try {\n          data = msg.payload.split(\";\");\n          context.global.nCell = parseInt(data[1]);\n          t = parseInt(data[1]);\n          context.global.nCellStack.push( parseInt(data[1]));\n        }\n    catch(error) {\n      data[0] = msg.payload;\n    }\n    //data = msg.payload ;\n    var msg = {};\n    msg.topic = 'Camera1'\n    msg.payload = \"done\";\n    msg.action = 'GRAB';\n    msg.device = 'PHOTOMETRICS-EVOLV-512';\n    msg.update = {'name' : data[0], 'nCell' : t};\n    msg.status = {\"SUCCESS\" : Date.now()};\n    node.send(msg);\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 740,
        "wires": [
            [
                "6be44e13.6e89f",
                "7db016cf.ed4298",
                "a2b9cf72.dd788"
            ]
        ],
        "icon": "node-red/camera.png"
    },
    {
        "id": "15970796.a11128",
        "type": "OlympusIx81",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "x": 750,
        "y": 1240,
        "wires": [
            [
                "cb926656.1428b8",
                "21d72bf5.9099e4",
                "6be44e13.6e89f",
                "2b15c60a.1c8aba"
            ]
        ]
    },
    {
        "id": "c1d76272.5e2a5",
        "type": "file in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "C:\\Users\\labo\\.node-red\\lib2\\mda\\list.txt",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 840,
        "y": 260,
        "wires": [
            [
                "1accd548.9227cb"
            ]
        ]
    },
    {
        "id": "1accd548.9227cb",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Initialisation",
        "func": "context.global.listConfigMda = msg.payload.split(\";\");\n//context.global.initialize = false ;\n//context.global.ressources = [] ;\n\n//context.global.test = [];\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1170,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "4cfe5530.7e20cc",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "save config mda",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\";\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\nvar output = {} ;\nif(order[0] === 'saveMDA'){\n    if(order[1] ===''){\n        output.filename = context.global.saveConfigMda;\n    }\n    else {\n        context.global.saveConfigMda = 'C:/Users/labo/.node-red/lib2/mda/'+order[1]+'.json';\n        output.filename = context.global.saveConfigMda ;\n        context.global.listConfigMda.push(order[1]+\".json\");\n    }\n    output.payload =  order[2];\n    node.send(output);\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2200,
        "y": 800,
        "wires": [
            [
                "15facc88.7ad4f3"
            ]
        ]
    },
    {
        "id": "15facc88.7ad4f3",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "x": 2690,
        "y": 800,
        "wires": [
            []
        ]
    },
    {
        "id": "d37e8f15.20f5e",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "extend config channel",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\";\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\nvar output = {} ;\nif((order[0] === 'saveMDA')&&(order[1]!=='')){\n    output.payload = \";\"+order[1]+\".json\";\n    node.send(output);\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2220,
        "y": 840,
        "wires": [
            [
                "1f78d5b4.da71ca"
            ]
        ]
    },
    {
        "id": "1f78d5b4.da71ca",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "C:\\Users\\labo\\.node-red\\lib2\\mda\\list.txt",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "false",
        "x": 2580,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "98c818c.0bedce8",
        "type": "link out",
        "z": "cfcb4c03.e7a76",
        "name": "MDA-FINISH",
        "links": [
            "85521727.c73ea8",
            "99d4378.0d09ac8"
        ],
        "x": 2295,
        "y": 960,
        "wires": []
    },
    {
        "id": "85521727.c73ea8",
        "type": "link in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "links": [
            "98c818c.0bedce8"
        ],
        "x": 435,
        "y": 300,
        "wires": [
            [
                "5de57813.63b368",
                "20f1ead8.5a6506",
                "69f24398.15e8cc"
            ]
        ]
    },
    {
        "id": "64a15fd1.9a7d",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 400,
        "y": 500,
        "wires": [
            [
                "5de57813.63b368",
                "20f1ead8.5a6506",
                "646a577e.9a0c78"
            ]
        ]
    },
    {
        "id": "5d3e117a.3d14c",
        "type": "link out",
        "z": "cfcb4c03.e7a76",
        "name": "MDA-START",
        "links": [
            "8baea63.42b5358"
        ],
        "x": 2655,
        "y": 920,
        "wires": []
    },
    {
        "id": "8baea63.42b5358",
        "type": "link in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "links": [
            "5d3e117a.3d14c"
        ],
        "x": 215,
        "y": 440,
        "wires": [
            [
                "64a15fd1.9a7d",
                "e587840e.559728"
            ]
        ]
    },
    {
        "id": "d22feb0f.8445b8",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "filter tree",
        "func": "if(msg.payload.substr(0,11) === '{\"expanded\"')return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2180,
        "y": 920,
        "wires": [
            [
                "d326cbab.6cdc68"
            ]
        ]
    },
    {
        "id": "646a577e.9a0c78",
        "type": "pythonshell in",
        "z": "cfcb4c03.e7a76",
        "name": "Camera",
        "pyfile": "C:\\Users\\labo\\customizeNode\\node-red-contrib-photometrics-evolv-512\\PhotometricsEvolv512\\test2.py",
        "virtualenv": "",
        "continuous": false,
        "stdInData": false,
        "x": 760,
        "y": 500,
        "wires": [
            []
        ],
        "icon": "node-red/camera.png"
    },
    {
        "id": "90133e4d.1d9ec",
        "type": "websocket in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "server": "57d0174f.790978",
        "client": "",
        "x": 360,
        "y": 740,
        "wires": [
            [
                "10be0019.c535b"
            ]
        ]
    },
    {
        "id": "8a165cfd.54894",
        "type": "websocket out",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "server": "a09da2d9.ae78a",
        "client": "",
        "x": 1460,
        "y": 740,
        "wires": []
    },
    {
        "id": "7db016cf.ed4298",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "name GRAB",
        "func": "if(msg.payload !== 'STOP'){\n    msg.payload = msg.update.name+';'+msg.update.nCell;\n    node.send(msg);\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1250,
        "y": 740,
        "wires": [
            [
                "8a165cfd.54894"
            ]
        ]
    },
    {
        "id": "d9b7fa5c.49df48",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Camera sd.",
        "func": "if(msg.device === 'PHOTOMETRICS-EVOLV-512'){\n    if(msg.action === 'GRAB'){\n    msg.payload = \"GRAB,\"+msg.prefixe+','+msg.position+','+msg.channel+','+Date.now()+','+msg.exposure;\n    node.send(msg);\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 780,
        "wires": [
            [
                "f3a51aaf.51a2f8"
            ]
        ],
        "icon": "node-red/camera.png"
    },
    {
        "id": "f3a51aaf.51a2f8",
        "type": "websocket out",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "server": "3a7ea16c.f1526e",
        "client": "",
        "x": 1290,
        "y": 780,
        "wires": []
    },
    {
        "id": "e6aeccfa.45775",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3600,
        "y": 880,
        "wires": [
            [
                "27fbf353.69e49c"
            ]
        ]
    },
    {
        "id": "27fbf353.69e49c",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "msg.payload = context.global.sequence2;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3730,
        "y": 880,
        "wires": [
            [
                "a1d6c0c1.6568d"
            ]
        ]
    },
    {
        "id": "a1d6c0c1.6568d",
        "type": "debug",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 3910,
        "y": 880,
        "wires": []
    },
    {
        "id": "b4c6ec66.2272a",
        "type": "PhotometricsEvolv512",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "x": 770,
        "y": 820,
        "wires": [
            [
                "21d72bf5.9099e4"
            ]
        ]
    },
    {
        "id": "5290f15b.3e802",
        "type": "link out",
        "z": "cfcb4c03.e7a76",
        "name": "fancyTree",
        "links": [
            "c17aa123.ed879",
            "85fbb1a1.41fa3"
        ],
        "x": 2355,
        "y": 680,
        "wires": []
    },
    {
        "id": "c17aa123.ed879",
        "type": "link in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "links": [
            "5290f15b.3e802"
        ],
        "x": 335,
        "y": 1420,
        "wires": [
            [
                "d9b7fa5c.49df48",
                "97643878.87a698",
                "cff23c38.05aac",
                "15970796.a11128",
                "bfcffaa6.f55158",
                "ad44600a.ee96c"
            ]
        ]
    },
    {
        "id": "7498099d.b512b8",
        "type": "pythonshell in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pyfile": "C:\\Users\\labo\\customizeNode\\node-red-contrib-photometrics-evolv-512\\PhotometricsEvolv512\\app.py",
        "virtualenv": "",
        "continuous": false,
        "stdInData": false,
        "x": 780,
        "y": 300,
        "wires": [
            []
        ],
        "icon": "node-red/camera.png"
    },
    {
        "id": "2fd93f42.deda7",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "MODIF1",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\",\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\n\n    \nif((order[0] === 'posLigth')&&(order.length === 5)){\n    \n    if (!isNaN(parseInt(order[4])))\n        context.global.settingChannels[parseInt(order[1])]['update'][order[2]][parseInt(order[3])] = parseFloat(order[4]) ;\n    else \n        context.global.settingChannels[parseInt(order[1])]['update'][order[2]][parseInt(order[3])] = (order[4]) ;\n    msg.payload =  context.global.settingChannels;\n    if(context.global.saveConfigChannel !== '' ) msg.filename = context.global.saveConfigChannel;\n    myObject = context.global.settingChannels[parseInt(order[1])]['update'];\n    lettrine = String.fromCharCode(64+Object.keys(myObject).length);\n    msg.topic = 'mappingcolor'+context.global.settingChannels[parseInt(order[1])]['update'][lettrine][0] ;\n    msg.topic = msg.topic.replace('#','');\n    return msg ;\n}\nif((order[0] === 'posLigth')&&(parseInt(order[1])!==-1)&&(order.length===2)){\n    msg.payload =  context.global.settingChannels;\n    if(context.global.saveConfigChannel !== '' ) msg.filename = context.global.saveConfigChannel;\n    myObject = context.global.settingChannels[parseInt(order[1])]['update'];\n    lettrine = String.fromCharCode(64+Object.keys(myObject).length);\n    msg.topic = 'mappingcolor'+context.global.settingChannels[parseInt(order[1])]['update'][lettrine][0] ;\n    msg.topic = msg.topic.replace('#','');\n    return msg ;\n}\nif((order[0] === 'posLigth')&&(parseInt(order[1])===-1)){\n    msg.payload =  context.global.settingChannels;\n    if(context.global.saveConfigChannel !== '' ) msg.filename = context.global.saveConfigChannel;\n    msg.topic = 'mappingcolor808080' ;\n    return msg ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2180,
        "y": 560,
        "wires": [
            [
                "25da8045.a2cf1"
            ]
        ]
    },
    {
        "id": "c0fe2d37.bd6e5",
        "type": "http request",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "method": "GET",
        "ret": "txt",
        "url": "http://172.27.0.183:5000/{{{topic}}}",
        "tls": "",
        "x": 2710,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "c740fa51.07fe08",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "MODIF1",
        "func": "var order = [] ;\ntry {\n  order = msg.payload.split(\",\");\n}\ncatch(error) {\n  order[0] = msg.payload;\n}\n\n    \nif((order[0] === 'posInvert')){\n    msg.payload =  \"\";\n    msg.topic = 'invert'+ order[1] ;\n    return msg ;\n}\nif((order[0] === 'posExposure')){\n    msg.payload =  \"\";\n    msg.topic = 'exposure'+ parseInt(order[1]) ;\n    return msg ;\n}\nif((order[0] === 'posMap')){\n    msg.payload =  \"\";\n    msg.topic = 'map'+ (order[1]) ;\n    return msg ;\n}\nif((order[0] === 'mappingcolor')){\n    msg.payload =  \"\";\n    msg.topic = 'mappingcolor'+ (order[1]) ;\n    return msg ;\n}\nif((order[0] === 'posAutoBC')){\n    msg.payload =  \"\";\n    msg.topic = 'autoBC'+ order[1] ;\n    return msg ;\n}\nif((order[0] === 'posGain')){\n    msg.payload =  \"\";\n    msg.topic = 'gain'+ order[1] ;\n    return msg ;\n}\nif((order[0] === 'posCross')){\n    msg.payload =  \"\";\n    msg.topic = 'cross'+ order[1] ;\n    return msg ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2180,
        "y": 600,
        "wires": [
            [
                "c0fe2d37.bd6e5"
            ]
        ]
    },
    {
        "id": "25da8045.a2cf1",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "x": 2350,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "e587840e.559728",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "stop live",
        "func": "msg.payload =  'quit';\nmsg.topic   = 'quit';\nreturn msg ;",
        "outputs": 1,
        "noerr": 0,
        "x": 400,
        "y": 440,
        "wires": [
            [
                "c3e7d807.b190d8"
            ]
        ]
    },
    {
        "id": "c3e7d807.b190d8",
        "type": "http request",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "method": "GET",
        "ret": "txt",
        "url": "http://127.0.0.1:5000/{{{topic}}}",
        "tls": "",
        "x": 750,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "c511580e.4ad518",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "protocole N",
        "func": "var mda = msg.payload ;\nvar output = {} ;\n\ntry {\n    if(mda['type'] === 'mda'){\n        if(mda.children[0].data.algo === 'algo1'){\n            output = algo1(mda);\n        }\n        msg.payload = \"MDA-START\" ;\n        context.global.sequence2 = output ;\n        return msg;   \n    }\n   \n}\ncatch(error){}\n\nfunction algo1(mda){\n    var test = {} ;\n    var inject = [] ;           \n    /*inject.push({\n        'payload' :  context.global.Fluorescence1,\n        'topic' : 'Fluorescence1',\n        'device' :  context.global.Fluorescence1,\n        'mode' : 'mda',\n        'action' : 'setOFF'\n    });\n    inject.push({\n        'payload' :  context.global.Microscope1,\n        'topic' : 'Microscope1',\n        'device' :  context.global.Microscope1,\n        'mode' : 'mda',\n        'action' : 'setOFF'\n    });\n    test[String(0)].push(inject);\n    inject = [] ;\n    inject.push({\n        'topic' : 'Microscope1',\n        'device' : context.global.Microscope1,\n        'action' : 'setChannel',\n        'mode' : 'MDA',\n        'update' : {\n            'lamp' : true,\n            'intensity': parseInt(context.global.settingChannels[l].update.A[1]),\n            'shutter': false,\n            'timeout' : -1\n        } \n    });\n    test[String(0)].push(inject);*/\n    //repeat sequence\n        for(var i=0; i<parseInt(mda.children[0].children[0].data.repeat);i++){\n            test[String(i*parseInt(mda.children[0].children[0].data.time))] = [] ;\n            //position\n            for(var ii=0; ii<mda.children[0].children[0].children.length;ii++){\n                \n                if(mda.children[0].children[0].children[ii].children[iii].type === 'ZS'){\n                    var zstart = parseInt(mda.children[0].children[0].children[ii].children[iii].data.zstart);\n                    var zend = parseInt(mda.children[0].children[0].children[ii].children[iii].data.zend);\n                    var zstep = parseInt(mda.children[0].children[0].children[ii].children[iii].data.zstep);\n                    var inc = zstart - zend ;\n                    if (inc<0) inc = inc * (-1) ;\n                    var stepping =  (inc / zstep) ;\n                    var zPosition = parseInt(mda.children[0].children[0].children[ii].data.zPosition);\n                }    \n                \n                var limit = 1 ;\n                for(var r=0;r<limit;r++){    \n                    var titlePisition = mda.children[0].children[0].children[ii].title ;\n                    inject = [] ;           \n                    //go to position x et y \n                    inject.push({\n                        'payload' :  context.global.MotionStage1,\n                        'topic' : 'MotionStage1',\n                        'device' :  context.global.MotionStage1,\n                        'mode' : 'MDA',\n                        'action' : 'set',\n                        'update' : {\n                            \"xPosition\" : parseInt(mda.children[0].children[0].children[ii].data.xPosition),\n                            \"yPosition\" : parseInt(mda.children[0].children[0].children[ii].data.yPosition),\n                            \"moveType\" : \"G\"\n                            }\n                        });\n                    //go to z position\n                    inject.push({\n                        'topic' : 'Microscope1',\n                        'device' : context.global.Microscope1,\n                        'action' : 'setZposition',\n                        'mode' : 'MDA',\n                        'update' : {\n                            'zPosition': parseInt(mda.children[0].children[0].children[ii].data.zPosition),\n                            'moveType' : 'd'\n                            }\n                        });\n                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                    //in the position\n                    for(var iii=0; iii<mda.children[0].children[0].children[ii].children.length;iii++){\n                        //filter\n                        if(mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'){\n                            inject = [] ;\n                            inject.push({\n                                'topic' : 'Microscope1',\n                                'device' : context.global.Microscope1,\n                                'action' : 'setWheelFilter',\n                                'mode' : 'MDA',\n                                'update':{\n                                    'wheelFilter': parseInt(mda.children[0].children[0].children[ii].children[iii].data.wheel)\n                                    }\n                                });\n                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                        }\n                        //set Ligth\n                        for(var l=1; l<context.global.settingChannels.length; l++){\n                            if(context.global.settingChannels[l].name === mda.children[0].children[0].children[ii].children[iii].data.title2){\n                                var exposure = -1 ;\n                                inject = [];\n                                //BF\n                                var titleChannel = mda.children[0].children[0].children[ii].children[iii].data.title2 ;\n                                if(context.global.settingChannels[l].device === \"OLYMPUS-IX-81\"){\n                                    inject.push({\n                                        'topic' : context.global.settingChannels[l].topic,\n                                        'device' : context.global.settingChannels[l].device,\n                                        'action' : 'setChannel',\n                                        'mode' : 'MDA',\n                                        'update' : {\n                                            'lamp' : true,\n                                            'intensity': parseInt(context.global.settingChannels[l].update.A[1]),\n                                            'shutter': true,\n                                            'timeout' : parseInt(mda.children[0].children[0].children[ii].children[iii].data.time),\n                                            'keep' : false\n                                        } \n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    exposure = 100;//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                //COOLLED\n                                if(context.global.settingChannels[l].device === \"CoolLed-PE4000\"){\n                                    inject.push({\n                                        'topic' : context.global.settingChannels[l].topic,\n                                        'device' : context.global.settingChannels[l].device,\n                                        'action' : 'setChannel',\n                                        'mode' : 'MDA',\n                                        'update' : {\n                                            \"A\" :[parseInt(context.global.settingChannels[l].update.A[0]),parseInt(context.global.settingChannels[l].update.A[1]),context.global.settingChannels[l].update.A[2] == \"ON\" ? false : true],\n                                            \"B\" :[parseInt(context.global.settingChannels[l].update.B[0]),parseInt(context.global.settingChannels[l].update.B[1]),context.global.settingChannels[l].update.B[2] == \"ON\" ? false : true],\n                                            \"C\" :[parseInt(context.global.settingChannels[l].update.C[0]),parseInt(context.global.settingChannels[l].update.C[1]),context.global.settingChannels[l].update.C[2] == \"ON\" ? false : true],\n                                            \"D\" :[parseInt(context.global.settingChannels[l].update.D[0]),parseInt(context.global.settingChannels[l].update.D[1]),context.global.settingChannels[l].update.D[2] == \"ON\" ? false : true],\n                                            'timeout' : parseInt(mda.children[0].children[0].children[ii].children[iii].data.time),\n                                            'keep' : false\n                                        }\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    exposure = 10;//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                            }\n                        }\n                        \n                        if(mda.children[0].children[0].children[ii].children[iii].type === 'CAMERA'){\n                            inject = [];\n                            inject.push({\n                                'topic' : 'Camera1',\n                                'device' : context.global.Camera1,\n                                'action' : 'GRAB',\n                                'prefixe' : mda.children[0].data.prefixe,\n                                'channel': titleChannel,\n                                'position' : titlePisition,  \n                                'exposure' : exposure \n                                });\n                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                            if(exposure !== -1){\n                                if(ii!==mda.children[0].children[0].children.length-1){\n                                    inject = [];\n                                    inject.push({\n                                        'action' : '_waiting_',\n                                        });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    exposure = -1 ;\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        \n            if(i === parseInt(mda.children[0].children[0].data.repeat)-1){\n                inject =\n                [{\n                'payload' : 'MDA-FINISH',\n                }];\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n            }            \n        }\n        return test ;    \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 3310,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "c29dab4e.a5d958",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Protocol 01022019",
        "func": "var mda = msg.payload ;\nvar output = {} ;\n\ntry {\n    if(mda['type'] === 'mda'){\n        if(mda.children[0].data.algo === 'algo1'){\n            output = algo1(mda);\n        }\n        msg.payload = \"MDA-START\" ;\n        context.global.sequence2 = output ;\n        return msg;   \n    }\n   \n}\ncatch(error){}\n\nfunction algo1(mda){\n    \n    var test = {} ;\n    /*Algo 1\n    sequence\n    ----position\n        ----light\n        ----zs ou camera\n        ----light\n        ----zs ou came\n            ....\n    ----position\n        ....\n    */    \n    //repeat sequence\n        for(var i=0; i<parseInt(mda.children[0].children[0].data.repeat);i++){\n            test[String(i*parseInt(mda.children[0].children[0].data.time))] = [] ;\n\n            //position\n            for(var ii=0; ii<mda.children[0].children[0].children.length;ii++){\n                var titlePisition = mda.children[0].children[0].children[ii].title ;\n                var inject = [] ;           \n                //go to position x et y \n                inject.push({\n                    'payload' :  context.global.MotionStage1,\n                    'topic' : 'MotionStage1',\n                    'device' :  context.global.MotionStage1,\n                    'mode' : 'MDA',\n                    'action' : 'set',\n                    'update' : {\n                        \"xPosition\" : parseInt(mda.children[0].children[0].children[ii].data.xPosition),\n                        \"yPosition\" : parseInt(mda.children[0].children[0].children[ii].data.yPosition),\n                        \"moveType\" : \"G\"\n                        }\n                    });\n                //go to z position\n                /*inject.push({\n                    'topic' : 'Microscope1',\n                    'device' : context.global.Microscope1,\n                    'action' : 'setZposition',\n                    'mode' : 'MDA',\n                    'update' : {\n                        'zPosition': parseInt(mda.children[0].children[0].children[ii].data.zPosition),\n                        }\n                    });\n                */\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                //in the position\n                for(var iii=0; iii<mda.children[0].children[0].children[ii].children.length;iii++){\n                    //filter\n                    var limit = 1 ;\n                    var keep = false ;\n                    var zPosition =parseInt(mda.children[0].children[0].children[ii].data.zPosition);\n                    node.warn(zPosition);\n                    var active = 0 ;\n                    if(mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'){\n                        inject = [] ;\n                        inject.push({\n                            'topic' : 'Microscope1',\n                            'device' : context.global.Microscope1,\n                            'action' : 'setWheelFilter',\n                            'mode' : 'MDA',\n                            'update':{\n                                'wheelFilter': parseInt(mda.children[0].children[0].children[ii].children[iii].data.wheel)\n                                }\n                            });\n                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                    \n                        // detect image or zstack AND set limit for the repeat loop\n                        if(mda.children[0].children[0].children[ii].children[iii+1].type === 'CAMERA'){\n                            limit = 1 ;\n                            keep = false ;\n                            active = 0 ;\n                        }\n                        if(mda.children[0].children[0].children[ii].children[iii+1].type === 'ZS'){\n                            var zstart = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zstart);\n                            var zend = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zend);\n                            var zstep = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zstep);\n                            var progress = parseInt(Math.abs(zstart-zend) / zstep) + 1 ;\n                            limit = progress ;\n                            keep = mda.children[0].children[0].children[ii].children[iii+1].data.shutter ;\n                            active = 1 ;\n                        }\n                    }\n                        \n                    if(true) {\n                        for(var r=0;r<limit;r++){\n                            if(r===limit-1) keep = false ;\n                            inject = [] ;\n                            var a  = (zPosition + active * 100*(zstart + zstep * r));\n                            inject.push({\n                                'topic' : 'Microscope1',\n                                'device' : context.global.Microscope1,\n                                'action' : 'setZposition',\n                                'mode' : 'MDA',\n                                'update' : {\n                                    'zPosition': a,\n                                    'moveType' : 'd'\n                                    }\n                                });\n                           if(mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT')\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                       \n                            //set Ligth\n                            if(mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'){\n                                for(var l=1; l<context.global.settingChannels.length; l++){\n                                    if(context.global.settingChannels[l].name === mda.children[0].children[0].children[ii].children[iii].data.title2){\n                                        var exposure = -1 ;\n                                        inject = [];\n                                        //BF\n                                        var titleChannel = mda.children[0].children[0].children[ii].children[iii].data.title2 ;\n                                        if(context.global.settingChannels[l].device === \"OLYMPUS-IX-81\"){\n                                            inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    'lamp' : true,\n                                                    'intensity': parseInt(context.global.settingChannels[l].update.A[1]),\n                                                    'shutter': true,\n                                                    'keep' : keep ,\n                                                    'timeout' : parseInt(mda.children[0].children[0].children[ii].children[iii].data.time)\n                                                } \n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = 200; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                        //COOLLED\n                                        if(context.global.settingChannels[l].device === \"CoolLed-PE4000\"){\n                                            inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    \"A\" :[parseInt(context.global.settingChannels[l].update.A[0]),parseInt(context.global.settingChannels[l].update.A[1]),context.global.settingChannels[l].update.A[2] == \"ON\" ? true : false],\n                                                    \"B\" :[parseInt(context.global.settingChannels[l].update.B[0]),parseInt(context.global.settingChannels[l].update.B[1]),context.global.settingChannels[l].update.B[2] == \"ON\" ? true : false],\n                                                    \"C\" :[parseInt(context.global.settingChannels[l].update.C[0]),parseInt(context.global.settingChannels[l].update.C[1]),context.global.settingChannels[l].update.C[2] == \"ON\" ? true : false],\n                                                    \"D\" :[parseInt(context.global.settingChannels[l].update.D[0]),parseInt(context.global.settingChannels[l].update.D[1]),context.global.settingChannels[l].update.D[2] == \"ON\" ? true : false],\n                                                    'timeout' : parseInt(mda.children[0].children[0].children[ii].children[iii].data.time),\n                                                    'keep': keep\n                                                    }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = 100; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                    }\n                                }\n                            }\n                            if(mda.children[0].children[0].children[ii].children[iii].type === 'CAMERA'){\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Camera1',\n                                    'device' : context.global.Camera1,\n                                    'action' : 'GRAB',\n                                    'prefixe' : mda.children[0].data.prefixe,\n                                    'channel': titleChannel,\n                                    'position' : titlePisition,  \n                                    'exposure' : exposure \n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                if(exposure !== -1){\n                                    if(ii!==mda.children[0].children[0].children.length-1){\n                                            inject = [];\n                                            inject.push({'action' : '_waiting_',});\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = -1 ;\n                                        }\n                                }\n\n                            }\n                            if((limit > 1)&&(mda.children[0].children[0].children[ii].children[iii].type !== 'ZS')){\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Camera1',\n                                    'device' : context.global.Camera1,\n                                    'action' : 'GRAB',\n                                    'prefixe' : mda.children[0].data.prefixe,\n                                    'channel': titleChannel,\n                                    'position' : titlePisition,  \n                                    'exposure' : exposure \n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                if(exposure !== -1){\n                                    if(ii!==mda.children[0].children[0].children.length-1){\n                                            inject = [];\n                                            inject.push({'action' : '_waiting_'});\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = -1 ;\n                                        }\n                                }\n                            }\n                        \n                        }\n                    }\n                }\n            }\n        \n            if(i === parseInt(mda.children[0].children[0].data.repeat)-1){\n                inject =[{'payload' : 'MDA-FINISH'}];\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n            }            \n        }\n        return test ;    \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 3290,
        "y": 800,
        "wires": [
            []
        ]
    },
    {
        "id": "629b20ca.cd05d",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "protocole N",
        "func": "var mda = msg.payload ;\nvar output = {} ;\n\ntry {\n    if(mda['type'] === 'mda'){\n        if(mda.children[0].data.algo === 'algo1'){\n            output = algo1(mda);\n        }\n        msg.payload = \"MDA-START\" ;\n        context.global.sequence2 = output ;\n        return msg;   \n    }\n   \n}\ncatch(error){}\n\nfunction algo1(mda){\n    var test = {} ;\n    var inject = [] ;           \n    /*inject.push({\n        'payload' :  context.global.Fluorescence1,\n        'topic' : 'Fluorescence1',\n        'device' :  context.global.Fluorescence1,\n        'mode' : 'mda',\n        'action' : 'setOFF'\n    });\n    inject.push({\n        'payload' :  context.global.Microscope1,\n        'topic' : 'Microscope1',\n        'device' :  context.global.Microscope1,\n        'mode' : 'mda',\n        'action' : 'setOFF'\n    });\n    test[String(0)].push(inject);\n    inject = [] ;\n    inject.push({\n        'topic' : 'Microscope1',\n        'device' : context.global.Microscope1,\n        'action' : 'setChannel',\n        'mode' : 'MDA',\n        'update' : {\n            'lamp' : true,\n            'intensity': parseInt(context.global.settingChannels[l].update.A[1]),\n            'shutter': false,\n            'timeout' : -1\n        } \n    });\n    test[String(0)].push(inject);*/\n    //repeat sequence\n        for(var i=0; i<parseInt(mda.children[0].children[0].data.repeat);i++){\n            test[String(i*parseInt(mda.children[0].children[0].data.time))] = [] ;\n            //position\n            for(var ii=0; ii<mda.children[0].children[0].children.length;ii++){\n                var limit = 1;\n                var zs = false ;\n                var keep = false;\n                // if(mda.children[0].children[0].children[ii].children[iii].type === 'ZS'){\n                    //zs = true ;\n                    //keep = true ;\n                    //var zstart = parseInt(mda.children[0].children[0].children[ii].children[iii].data.zstart);\n                    //var zend = parseInt(mda.children[0].children[0].children[ii].children[iii].data.zend);\n                    //var zstep = parseInt(mda.children[0].children[0].children[ii].children[iii].data.zstep);\n                    //var inc = zstart - zend ;\n                    //if (inc<0) inc = inc * (-1) ;\n                    //var stepping =  (inc / zstep) ;\n                    //var zPosition = parseInt(mda.children[0].children[0].children[ii].data.zPosition);\n                    //limit = stepping;\n                    //node.warn(stepping);\n                // }    \n                for(var r=0;r<limit;r++){\n                    var titlePisition = mda.children[0].children[0].children[ii].title ;\n                    if(zs===false){\n                        inject = [] ;           \n                        //go to position x et y \n                        inject.push({\n                            'payload' :  context.global.MotionStage1,\n                            'topic' : 'MotionStage1',\n                            'device' :  context.global.MotionStage1,\n                            'mode' : 'MDA',\n                            'action' : 'set',\n                            'update' : {\n                                \"xPosition\" : parseInt(mda.children[0].children[0].children[ii].data.xPosition),\n                                \"yPosition\" : parseInt(mda.children[0].children[0].children[ii].data.yPosition),\n                                \"moveType\" : \"G\"\n                                }\n                            });\n                    }\n                    //go to z position\n                    var z = 0;\n                    if(zs===false) z = parseInt(mda.children[0].children[0].children[ii].data.zPosition);\n                    else z = parseInt(mda.children[0].children[0].children[ii].data.zPosition) + 100*(zstart + zstep * r);\n                    inject.push({\n                        'topic' : 'Microscope1',\n                        'device' : context.global.Microscope1,\n                        'action' : 'setZposition',\n                        'mode' : 'MDA',\n                        'update' : {\n                            'zPosition': z,\n                            'moveType' : 'd'\n                            }\n                        });\n                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                    //in the position\n                    for(var iii=0; iii<mda.children[0].children[0].children[ii].children.length;iii++){\n                        //filter\n                        if(r===0){\n                            if(mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'){\n                                inject = [] ;\n                                inject.push({\n                                    'topic' : 'Microscope1',\n                                    'device' : context.global.Microscope1,\n                                    'action' : 'setWheelFilter',\n                                    'mode' : 'MDA',\n                                    'update':{\n                                        'wheelFilter': parseInt(mda.children[0].children[0].children[ii].children[iii].data.wheel)\n                                        }\n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                            }\n                        }\n                        //set Ligth\n                        for(var l=1; l<context.global.settingChannels.length; l++){\n                            if(context.global.settingChannels[l].name === mda.children[0].children[0].children[ii].children[iii].data.title2){\n                                var exposure = -1 ;\n                                inject = [];\n                                //BF\n                                var titleChannel = mda.children[0].children[0].children[ii].children[iii].data.title2 ;\n                                if(context.global.settingChannels[l].device === \"OLYMPUS-IX-81\"){\n                                    inject.push({\n                                        'topic' : context.global.settingChannels[l].topic,\n                                        'device' : context.global.settingChannels[l].device,\n                                        'action' : 'setChannel',\n                                        'mode' : 'MDA',\n                                        'update' : {\n                                            'lamp' : true,\n                                            'intensity': parseInt(context.global.settingChannels[l].update.A[1]),\n                                            'shutter': true,\n                                            'timeout' : parseInt(mda.children[0].children[0].children[ii].children[iii].data.time),\n                                            'keep' : keep\n                                        } \n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    exposure = 100;//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                //COOLLED\n                                if(context.global.settingChannels[l].device === \"CoolLed-PE4000\"){\n                                    inject.push({\n                                        'topic' : context.global.settingChannels[l].topic,\n                                        'device' : context.global.settingChannels[l].device,\n                                        'action' : 'setChannel',\n                                        'mode' : 'MDA',\n                                        'update' : {\n                                            \"A\" :[parseInt(context.global.settingChannels[l].update.A[0]),parseInt(context.global.settingChannels[l].update.A[1]),context.global.settingChannels[l].update.A[2] == \"ON\" ? false : true],\n                                            \"B\" :[parseInt(context.global.settingChannels[l].update.B[0]),parseInt(context.global.settingChannels[l].update.B[1]),context.global.settingChannels[l].update.B[2] == \"ON\" ? false : true],\n                                            \"C\" :[parseInt(context.global.settingChannels[l].update.C[0]),parseInt(context.global.settingChannels[l].update.C[1]),context.global.settingChannels[l].update.C[2] == \"ON\" ? false : true],\n                                            \"D\" :[parseInt(context.global.settingChannels[l].update.D[0]),parseInt(context.global.settingChannels[l].update.D[1]),context.global.settingChannels[l].update.D[2] == \"ON\" ? false : true],\n                                            'timeout' : parseInt(mda.children[0].children[0].children[ii].children[iii].data.time),\n                                            'keep' : keep\n                                        }\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    exposure = 10;//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                            }\n                        }\n                        if((mda.children[0].children[0].children[ii].children[iii].type === 'CAMERA')||(zs===true)){\n                            inject = [];\n                            inject.push({\n                                'topic' : 'Camera1',\n                                'device' : context.global.Camera1,\n                                'action' : 'GRAB',\n                                'prefixe' : mda.children[0].data.prefixe,\n                                'channel': titleChannel,\n                                'position' : titlePisition,  \n                                'exposure' : exposure \n                                });\n                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                            if(exposure !== -1){\n                                if(ii!==mda.children[0].children[0].children.length-1){\n                                    inject = [];\n                                    inject.push({\n                                        'action' : '_waiting_',\n                                        });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    exposure = -1 ;\n                                }\n                            }\n                        }\n                        \n                        //picture+af\n                        //faire el stop\n                        //af et zs\n                \n                    }    \n                }\n            }\n        \n            if(i === parseInt(mda.children[0].children[0].data.repeat)-1){\n                inject =\n                [{\n                'payload' : 'MDA-FINISH',\n                }];\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n            }            \n        }\n        return test ;    \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 3310,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "6d39b39b.11964c",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Protocol 19022019a",
        "func": "var mda = msg.payload ;\nvar output = {} ;\n\ntry {\n    if(mda['type'] === 'mda'){\n       // if(mda.children[0].data.algo === 'algo1'){\n            try{\n                output = algo1(mda);\n            } catch(err){node.warn(\"ERRR\");}\n       // }\n        msg.payload = \"MDA-START\" ;\n        context.global.sequence2 = output ;\n        context.global.lockValve1 = false ;\n        context.global.lockValve2 = false ;\n        context.global.lockValve3 = false ;\n        context.global.lockValve4 = false ;\n        context.global.lockValve5 = false ;\n\n        context.global.nCell = -1 ;\n        context.global.nCellStack = [] ;\n        return msg;   \n    }\n   \n}\ncatch(error){}\n\nfunction algo1(mda){\n    \n    var test = {} ;\n    /*Algo 1\n    sequence\n    ----position\n        ----light\n        ----zs ou camera\n        ----light\n        ----zs ou came\n            ....\n    ----position\n        ....\n    */    \n    \n   \n    \n            \n    //repeat sequence\n        for(var i=0; i<parseInt(mda.children[0].children[0].data.repeat);i++){\n            test[String(i*parseInt(mda.children[0].children[0].data.time))] = [] ;\n\n\n\n\n        if(i===0){\n             //BF initialisation car long pour l'instant papramètres statiques\n                /*\n                inject = [];\n                inject.push({\n                    'topic' : 'Microscope1',\n                    'device' : 'OLYMPUS-IX-81',\n                    'action' : 'setChannel',\n                    'mode' : 'MDA',\n                    'update' : {\n                        'lamp' : true,\n                        'intensity':  2,\n                        'shutter': false,\n                        'keep' : false ,\n                        'timeout' : -1///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time)\n                    } \n                });\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                */\n                \n                \n                for(var l=1; l<context.global.settingChannels.length; l++){\n//                    if(context.global.settingChannels[l].name === mda.children[0].children[0].children[ii].children[iii].data.title2){\n//                        var exposure = -1 ;\n                        inject = [];\n                        //BF\n                        if(context.global.settingChannels[l].device === \"OLYMPUS-IX-81\"){\n                            device = context.global.settingChannels[l].device ;\n                            topic = context.global.settingChannels[l].topic ;\n                            inject.push({\n                                'topic' : context.global.settingChannels[l].topic,\n                                'device' : context.global.settingChannels[l].device,\n                                'action' : 'setChannel',\n                                'mode' : 'MDA',\n                                'update' : {\n                                    'lamp' : true,\n                                    'intensity': (context.global.settingChannels[l].update.A[0]),\n                                    'shutter': false,\n                                    'keep' : false ,\n                                    'timeout' : -1///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time)\n                                } \n                            });\n                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                        }\n//                    }\n                }\n                \n                \n                //temporisation\n                inject = [];\n                inject.push({\n                    'topic' : 'f_tempo',\n                    'device' : 'none',\n                    'action' : 'f_tempo',\n                    'update' : {\n                        't' : 1000\n                    }\n                });\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n        }\n                \n            //position\n            for(var ii=0; ii<mda.children[0].children[0].children.length;ii++){\n                var af = false; //////////////////////////////\n                var titlePisition = mda.children[0].children[0].children[ii].title ;\n                var inject = [] ;           \n                  var q = 1;\n                  //go to position x et y \n                inject.push({\n                    'payload' :  context.global.MotionStage1,\n                    'topic' : 'MotionStage1',\n                    'device' :  context.global.MotionStage1,\n                    'mode' : 'MDA',\n                    'action' : 'set',\n                    'update' : {\n                        \"xPosition\" : parseInt(mda.children[0].children[0].children[ii].data.xPosition),\n                        \"yPosition\" : parseInt(mda.children[0].children[0].children[ii].data.yPosition),\n                        \"moveType\" : \"G\"\n                        }\n                    });\n                //go to z position\n                /*inject.push({\n                    'topic' : 'Microscope1',\n                    'device' : context.global.Microscope1,\n                    'action' : 'setZPosition',\n                    'mode' : 'MDA',\n                    'update' : {\n                        'zPosition': parseInt(mda.children[0].children[0].children[ii].data.zPosition),\n                        }\n                    });\n                */\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                //in the position\n                \n                for(var iii=0; iii<mda.children[0].children[0].children[ii].children.length;iii++){\n                     //////////////////////\n                    //filter\n                    var zstart = 0;\n                    var zend = 0;\n                    var zstep = 0;\n                          \n                    var limit = 1 ;\n                    //var af = false ; \n                    var keep = false ;\n                    var zPosition =parseInt(mda.children[0].children[0].children[ii].data.zPosition);\n                    var active = 0 ;\n////MF CONDITIONNEL\n                    if(mda.children[0].children[0].children[ii].children[iii].type === 'MF'){\n                        //af = true ;\n                       inject = [] ;\n                        inject.push({\n                            'topic' : 'MF',\n                            'device' : 'MF',\n                            'action' : 'MF',\n                            'update' : {\n                                \"v1\": mda.children[0].children[0].children[ii].children[iii].data.v1,\n                                \"v2\": mda.children[0].children[0].children[ii].children[iii].data.v2,\n                                \"v3\": mda.children[0].children[0].children[ii].children[iii].data.v3,\n                                \"v4\": mda.children[0].children[0].children[ii].children[iii].data.v4,\n                                \"v5\": mda.children[0].children[0].children[ii].children[iii].data.v5,\n                                \"t1\": mda.children[0].children[0].children[ii].children[iii].data.t1,\n                                \"t2\": mda.children[0].children[0].children[ii].children[iii].data.t2,\n                                \"t3\": mda.children[0].children[0].children[ii].children[iii].data.t3,\n                                \"t4\": mda.children[0].children[0].children[ii].children[iii].data.t4,\n                                \"t5\": mda.children[0].children[0].children[ii].children[iii].data.t5,\n                                \"cond\" : mda.children[0].children[0].children[ii].children[iii].data.cond,\n                                \"value\":mda.children[0].children[0].children[ii].children[iii].data.value\n                                \n                            }\n                            });\n                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                       /* inject = [];\n                                            inject.push({\n                                                'topic' : 'MF',\n                                                'device' : 'MF',\n                                                'action' : 'MF',\n                                                'update' : {\n                                                    't' : 10000\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);*/\n                    \n                    }\n\n////\n\n                    if(mda.children[0].children[0].children[ii].children[iii].type === 'AF'){\n                        af = true ;\n                        inject = [] ;\n                        inject.push({\n                            'topic' : 'Microscope1',\n                            'device' : context.global.Microscope1,\n                            'action' : 'af',\n                            'mode' : 'MDA',\n                            'update' : {\n                                \"farLimit\" : 1,\n                                \"nearLimit\" : 3000000,\n                                \"affLimit\": parseInt(mda.children[0].children[0].children[ii].children[iii].data.zPosition)-(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.lower)),\n                                \"afnLimit\": parseInt(mda.children[0].children[0].children[ii].children[iii].data.zPosition)+(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.upper)),\n                                \"objective\": parseInt(mda.children[0].children[0].children[ii].children[iii].data.n),\n                                \"offset\" : parseInt(mda.children[0].children[0].children[ii].children[iii].data.zOffset)\n                                }\n                            });\n                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                    \n                    }\n                    if((mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT')){\n                  \n                    \n                                  /*  if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                    if(( q !== 0)){\n                       //          node.warn(i+'-'+parseInt(mda.children[0].children[0].children[ii].children[iii].data.skip)+'-'+ (i+1)%parseInt(mda.children[0].children[0].children[ii].children[iii].data.skip) );\n                        /************************ remove wh\n                        inject = [] ;\n                        inject.push({\n                            'topic' : 'Microscope1',\n                            'device' : context.global.Microscope1,\n                            'action' : 'setWheelFilter',\n                            'mode' : 'MDA',\n                            'update':{\n                                'wheelFilter': parseInt(mda.children[0].children[0].children[ii].children[iii].data.wheel)\n                                }\n                            });\n                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                        *////////////////////////// remove wh \n                        // detect image or zstack AND set limit for the repeat loop\n                        if(mda.children[0].children[0].children[ii].children[iii+1].type === 'CAMERA'){\n                            limit = 1 ;\n                            keep = false ;\n                            active = 0 ;\n                        }\n                        if(mda.children[0].children[0].children[ii].children[iii+1].type === 'ZS'){\n                            zstart = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zstart);\n                            zend = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zend);\n                            zstep = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zstep);\n                            progress = parseInt(Math.abs(zstart-zend) / zstep) + 1 ;\n                            limit = progress ;\n                            keep = mda.children[0].children[0].children[ii].children[iii+1].data.shutter ;\n                            active = 1 ;\n                        }\n                    }\n                    }\n                        \n                    if(true) {\n//                        node.warn(\"limit:\"+limit);\n                        for(var r=0;r<limit;r++){\n                            \n                            if(r===limit-1) keep = false ;\n                            inject = [] ;\n                            var a  = (zPosition + active * 100*(zstart + zstep * r));\n                            \n                            \n                            //if(mda.children[0].children[0].children[ii].children[iii].type !== 'AF'){\n                            if(af === false){\n                                inject.push({\n                                    'topic' : 'Microscope1',\n                                    'device' : context.global.Microscope1,\n                                    'action' : 'setZPosition',\n                                    'mode' : 'MDA',\n                                    'update' : {\n                                        'zPosition': a,\n                                        'moveType' : 'd'\n                                        }\n                                    });\n                            } else {\n                                inject.push({\n                                    'topic' : 'f_tempo',\n                                    'device' : 'none',\n                                    'action' : 'f_tempo',\n                                    'update' : {\n                                        't' : 250\n                                    }\n                                });\n                            }\n                           if(mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'){\n                            \n                                  /*  if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                                if(( q !== 0)){\n                                      try{\n                                            if((mda.children[0].children[0].children[ii].children[iii-1].type !== 'AF')){\n                                                //if((mda.children[0].children[0].children[ii].children[iii-1].type !== 'MOSAIC'))\n                                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            }\n                                            if((mda.children[0].children[0].children[ii].children[iii+1].type === 'ZS')){\n                                                //if((mda.children[0].children[0].children[ii].children[iii-1].type !== 'MOSAIC'))\n                                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            }\n                                        }\n                                        catch(error){\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                        }\n                                }\n                                    }\n                                \n                            //AF\n                           /* if(mda.children[0].children[0].children[ii].children[iii].type === 'AF'){\n                                af = true ;\n                                inject = [] ;\n                                inject.push({\n                                    'topic' : 'Microscope1',\n                                    'device' : context.global.Microscope1,\n                                    'action' : 'af',\n                                    'mode' : 'MDA',\n                                    'update' : {\n                                        \"farLimit\" : 1,\n                                        \"nearLimit\" : 3000000,\n                                        \"affLimit\": zPosition-(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.lower)),\n                                        \"afnLimit\": zPosition+(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.upper)),\n                                        \"objective\": 30,\n                                        \"offset\" : parseInt(mda.children[0].children[0].children[ii].children[iii].data.zOffset)\n                                        }\n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                            \n                           }*/\n           \n           \n                   \n        \n                            //set Ligth\n                            if(((mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'))){\n                                \n                                /*\n                                    if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                    if(( q !== 0)){\n                      \n                                var device ;var topic ;\n                                for(var l=1; l<context.global.settingChannels.length; l++){\n                                    if(context.global.settingChannels[l].name === mda.children[0].children[0].children[ii].children[iii].data.title2){\n                                     \n                                        var exposure = -1 ;\n                                        inject = [];\n                                        //BF\n                                        var titleChannel = mda.children[0].children[0].children[ii].children[iii].data.title2 ;\n                                        if(context.global.settingChannels[l].device === \"OLYMPUS-IX-81\"){\n                                              /********** ajout wh\n                                             */\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : 'Microscope1',\n                                                'device' : context.global.Microscope1,\n                                                'action' : 'setWheelFilter2',\n                                                'mode' : 'MDA',\n                                                'update':{\n                                                    'wheelFilter': parseInt(context.global.settingChannels[l].update.C[0])\n                                                    }\n                                                });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            /*inject = [];\n                                            inject.push({\n                                                'topic' : 'f_tempo',\n                                                'device' : 'none',\n                                                'action' : 'f_tempo',\n                                                'update' : {\n                                                    't' : 2500\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);*/\n                                            /********/\n                                            device = context.global.settingChannels[l].device ;\n                                            topic = context.global.settingChannels[l].topic ;\n                                             inject = [] ;\n                                             inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    'lamp' : true,\n                                                    'intensity': (context.global.settingChannels[l].update.A[0]),\n                                                    'shutter': true,\n                                                    'keep' : keep ,\n                                                    'timeout' : -1///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time)\n                                                } \n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            //exposure = 200; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                        //COOLLED\n                                        if(context.global.settingChannels[l].device === \"CoolLed-PE4000\"){\n                                            /********** ajout wh\n                                             */\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : 'Microscope1',\n                                                'device' : context.global.Microscope1,\n                                                'action' : 'setWheelFilter',\n                                                'mode' : 'MDA',\n                                                'update':{\n                                                    'wheelFilter': parseInt(context.global.settingChannels[l].update.F[0])\n                                                    }\n                                                });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            inject = [];\n                                            inject.push({\n                                                'topic' : 'f_tempo',\n                                                'device' : 'none',\n                                                'action' : 'f_tempo',\n                                                'update' : {\n                                                    't' : 2500\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            /********/\n                                            device = context.global.settingChannels[l].device ;\n                                            topic = context.global.settingChannels[l].topic ;\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    \"A\" :[parseInt(context.global.settingChannels[l].update.A[0]),parseInt(context.global.settingChannels[l].update.A[1]),context.global.settingChannels[l].update.A[2] == \"ON\" ? true : false],\n                                                    \"B\" :[parseInt(context.global.settingChannels[l].update.B[0]),parseInt(context.global.settingChannels[l].update.B[1]),context.global.settingChannels[l].update.B[2] == \"ON\" ? true : false],\n                                                    \"C\" :[parseInt(context.global.settingChannels[l].update.C[0]),parseInt(context.global.settingChannels[l].update.C[1]),context.global.settingChannels[l].update.C[2] == \"ON\" ? true : false],\n                                                    \"D\" :[parseInt(context.global.settingChannels[l].update.D[0]),parseInt(context.global.settingChannels[l].update.D[1]),context.global.settingChannels[l].update.D[2] == \"ON\" ? true : false],\n                                                    'timeout' : -1,///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time),\n                                                    'keep': keep\n                                                    }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            //exposure = 100; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                        //x-cite\n                                        var intxcite = parseInt(context.global.settingChannels[l].update.A[0]) ;\n                                        if(context.global.settingChannels[l].device === \"X-Cite-120PC\"){\n                                             /********** ajout wh\n                                             */\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : 'Microscope1',\n                                                'device' : context.global.Microscope1,\n                                                'action' : 'setWheelFilter',\n                                                'mode' : 'MDA',\n                                                'update':{\n                                                    'wheelFilter': parseInt(context.global.settingChannels[l].update.C[0])\n                                                    }\n                                                });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            inject = [];\n                                            inject.push({\n                                                'topic' : 'f_tempo',\n                                                'device' : 'none',\n                                                'action' : 'f_tempo',\n                                                'update' : {\n                                                    't' : 2500\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            /********/\n                                            device = context.global.settingChannels[l].device ;\n                                            topic = context.global.settingChannels[l].topic ;\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    \"A\" :[parseInt(context.global.settingChannels[l].update.A[0]),true]\n                                                    }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            //exposure = 100; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                        \n                                    }\n                                }\n                            }}\n                            if(mda.children[0].children[0].children[ii].children[iii].type === 'MOSAIC'){\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Mosaic',\n                                    'device' : 'MOSAIC',\n                                    'action' : 'EXP',\n                                    'img' :  mda.children[0].children[0].children[ii].children[iii].data.image\n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                             \n                            }\n                            if(mda.children[0].children[0].children[ii].children[iii].type === 'NMOSAIC'){\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Mosaic',\n                                    'device' : 'MOSAIC',\n                                    'action' : 'NEXP',\n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                             \n                            }\n                            if((mda.children[0].children[0].children[ii].children[iii].type === 'CAMERA')){\n                            /*\n                             \n                                    if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                    if(( q !== 0)){\n                      \n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Camera1',\n                                    'device' : context.global.Camera1,\n                                    'action' : 'GRAB',\n                                    'prefixe' : mda.children[0].data.prefixe,\n                                    'channel': titleChannel,\n                                    'position' : titlePisition,  \n                                    'exposure' : exposure \n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                             \n                                inject = [];\n                                if(device === \"OLYMPUS-IX-81\"){\n                                    inject.push({\n                                        'topic' : topic,\n                                        'device' : device,\n                                        'action' : 'setOFF'\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    //exposure = 200; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                } \n                                \n                                if(device === \"CoolLed-PE4000\"){\n                                    inject.push({\n                                        'topic' : topic,\n                                        'device' : device,\n                                        'action' : 'setOFF'\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    //exposure = 100; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                if(device === \"X-Cite-120PC\"){\n                                    inject.push({\n                                        'device' : device ,\n                                            'topic' : topic ,\n                                            'action' : 'setChannel',\n                                            'mode' : 'MDA',\n                                            'update' : {\n                                                \"A\" :[intxcite,false]\n                                                }\n                                        });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    //exposure = 100; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                \n                                //a régler dynamiquement\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'f_tempo',\n                                    'device' : 'none',\n                                    'action' : 'f_tempo',\n                                    'update' : {\n                                        't' : 600\n                                    }\n                                });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                            \n                                \n                                \n                               /* if(exposure !== -1){\n                                    if(ii!==mda.children[0].children[0].children.length-1){\n                                            inject = [];\n                                            inject.push({'action' : '_waiting_',});\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = -1 ;\n                                        }\n                                }*/\n\n                            }\n                            }\n                            if((limit > 1)&&(mda.children[0].children[0].children[ii].children[iii].type !== 'ZS')){\n                            /*\n                                    if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                                \n                                if(( q !== 0)){\n                      \n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Camera1',\n                                    'device' : context.global.Camera1,\n                                    'action' : 'GRAB',\n                                    'prefixe' : mda.children[0].data.prefixe,\n                                    'channel': titleChannel,\n                                    'position' : titlePisition,  \n                                    'exposure' : exposure \n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                \n                                \n                                \n                                /*\n                                here shutter close during the z-stack\n                                */\n                                \n                                if(r===limit-1){ \n                                    inject = [];\n                                    if(device === \"OLYMPUS-IX-81\"){\n                                        inject.push({\n                                            'topic' : topic,\n                                            'device' : device,\n                                            'action' : 'setOFF'\n                                        });\n                                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                        //exposure = 200; //\n                                        //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                    } \n                                    \n                                    if(device === \"CoolLed-PE4000\"){\n                                        inject.push({\n                                            'topic' : topic,\n                                            'device' : device,\n                                            'action' : 'setOFF'\n                                        });\n                                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                        //exposure = 100; //\n                                        //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                    }\n\n                                    if(device === \"X-Cite-120PC\"){\n                                    inject.push({\n                                        'device' : device ,\n                                            'topic' : topic ,\n                                            'action' : 'setChannel',\n                                            'mode' : 'MDA',\n                                            'update' : {\n                                                \"A\" :[intxcite,\"OFF\"]\n                                                }\n                                        });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n\n                                    //a régler dynamiquement\n                                    inject = [];\n                                    inject.push({\n                                        'topic' : 'f_tempo',\n                                        'device' : 'none',\n                                        'action' : 'f_tempo',\n                                        'update' : {\n                                            't' : 300\n                                        }\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    \n                                    //exposure = 100; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                }\n                                \n                                /*if(exposure !== -1){\n                                    if(ii!==mda.children[0].children[0].children.length-1){\n                                            inject = [];\n                                            inject.push({'action' : '_waiting_'});\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = -1 ;\n                                        }\n                                }*/\n                            }}\n                        \n                        }\n                    }\n                }\n            }\n        \n            if(i === parseInt(mda.children[0].children[0].data.repeat)-1){\n                inject =[{'payload' : 'MDA-FINISH'}];\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n            }            \n        }\n        return test ;    \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2480,
        "y": 920,
        "wires": [
            [
                "5d3e117a.3d14c"
            ]
        ]
    },
    {
        "id": "d377c06.1e99b4",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Timer syncro",
        "func": "if(msg.topic === 'f_tempo'){\n    node.status ({fill:\"green\",shape:\"dot\", text: \"request\"});\n    var time = parseInt(msg.update.t) ;\n    setTimeout(function(){\n        var msg = {};\n        msg.topic = 'f_tempo'\n        msg.payload = \"done\";\n        msg.action = 'f_tempo';\n        msg.device = 'none';\n        msg.update = {'t' : time};\n        node.status ({fill:\"yellow\",shape:\"dot\", text: \"send...\"});\n        node.send(msg);\n    },time)\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 700,
        "wires": [
            [
                "6be44e13.6e89f"
            ]
        ],
        "icon": "node-red/timer.png"
    },
    {
        "id": "69f24398.15e8cc",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "relunch",
        "func": "if(msg.payload === 'MDA-FINISH'){\n    node.send(msg);\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 580,
        "y": 300,
        "wires": [
            [
                "7498099d.b512b8"
            ]
        ]
    },
    {
        "id": "88938218.ab043",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 190,
        "y": 1700,
        "wires": [
            [
                "8b897c36.0ef6d",
                "ef1a0755.512528",
                "168ed2e5.24a90d",
                "956a6c18.924aa"
            ]
        ]
    },
    {
        "id": "9379d12b.1150c",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Connect, enables PC control of the unit. ",
        "func": "msg.payload = 'tt' ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 1700,
        "wires": [
            [
                "9cd5c253.97a92"
            ]
        ]
    },
    {
        "id": "5f773289.db619c",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": " enables the extended command set of the X-Cite exacte",
        "func": "msg.payload = 'jj' ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 1740,
        "wires": [
            [
                "9cd5c253.97a92"
            ]
        ]
    },
    {
        "id": "ce334604.ad5418",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Enable PC Shutter Control,",
        "func": "msg.payload = 'cc' ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 1780,
        "wires": [
            [
                "9cd5c253.97a92"
            ]
        ]
    },
    {
        "id": "8b897c36.0ef6d",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "0.3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 350,
        "y": 1740,
        "wires": [
            [
                "5f773289.db619c"
            ]
        ]
    },
    {
        "id": "ef1a0755.512528",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "0.6",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 350,
        "y": 1780,
        "wires": [
            [
                "ce334604.ad5418"
            ]
        ]
    },
    {
        "id": "168ed2e5.24a90d",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "0",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 340,
        "y": 1700,
        "wires": [
            [
                "9379d12b.1150c"
            ]
        ]
    },
    {
        "id": "8ff728ed.370bf8",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Turn CLF Off ",
        "func": "msg.payload = 'gg' ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 1820,
        "wires": [
            [
                "bf55b595.bd9708",
                "9cd5c253.97a92"
            ]
        ]
    },
    {
        "id": "956a6c18.924aa",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "0.9",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 350,
        "y": 1820,
        "wires": [
            [
                "8ff728ed.370bf8"
            ]
        ]
    },
    {
        "id": "799738c6.9b4b78",
        "type": "serial out",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "serial": "4c492437.085a0c",
        "x": 1280,
        "y": 1680,
        "wires": []
    },
    {
        "id": "bf55b595.bd9708",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "init",
        "func": "msg.payload = 'done' ; \nmsg.topic = \"Fluorescence2\"; \nmsg.device = 'X-Cite-120PC'; \nmsg.type = 'ligth-source' ; \nmsg.mode = 'init' ; \nmsg.action = 'set' ;\nmsg.update = {'A' : [],'B' : []} ;\nmsg.update['A'] = [10 ];\nmsg.update['B'] = [\"#EE2334\"];\nmsg.update['C'] = [\"1\"];\n\nmsg.config = {'A' : {}} ;\nmsg.config[\"A\"]=[\"Intensity: <input required name='%A0' id='%A0' type='number' min='0' max='100' step='1'/>\"] ;\nmsg.config[\"B\"]=[\"<br>Color mapping: <input required name='%B0' id='%B0' type='color'>\"];\nmsg.config[\"C\"]=[\"<br>Wheel Filter: <input required name='%C0' id='%C0' type='number' min='1' max='6' step='1'>\"];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 1820,
        "wires": [
            [
                "cff79316.44b75"
            ]
        ]
    },
    {
        "id": "bfcffaa6.f55158",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "X-CITE",
        "func": "\nif((msg.device === 'X-Cite-120PC') && (msg.action === 'setChannel')){\n        var msg2 = {};\n        node.warn(msg.update.A[0]);\n        if(parseInt(msg.update.A[0])< 10) msg.payload = 'd00'+msg.update.A[0];\n        if(parseInt(msg.update.A[0])>= 10) msg.payload = 'd0'+msg.update.A[0];\n        if(parseInt(msg.update.A[0])=== 100) msg.payload = 'd'+msg.update.A[0];\n        msg2.payload = msg.update.A[1] === true ? \"mm\" : \"zz\" ; \n        msg2.device = 'X-Cite-120PC';\n    \n    node.send([msg,msg2]);\n}\n\n",
        "outputs": 2,
        "noerr": 0,
        "x": 760,
        "y": 1540,
        "wires": [
            [
                "85fc9597.ac1f48"
            ],
            [
                "9f9ae82.cc0fc18"
            ]
        ],
        "icon": "node-red/camera.png"
    },
    {
        "id": "9f9ae82.cc0fc18",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "0.5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 930,
        "y": 1560,
        "wires": [
            [
                "9cd5c253.97a92",
                "3d3cdd6e.cb3482"
            ]
        ]
    },
    {
        "id": "85fc9597.ac1f48",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "0",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 920,
        "y": 1520,
        "wires": [
            [
                "9cd5c253.97a92"
            ]
        ]
    },
    {
        "id": "cff79316.44b75",
        "type": "link out",
        "z": "cfcb4c03.e7a76",
        "name": "init xcite",
        "links": [
            "a922b739.194b58"
        ],
        "x": 1035,
        "y": 1820,
        "wires": []
    },
    {
        "id": "a922b739.194b58",
        "type": "link in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "links": [
            "cff79316.44b75"
        ],
        "x": 1095,
        "y": 820,
        "wires": [
            [
                "21d72bf5.9099e4"
            ]
        ]
    },
    {
        "id": "9cd5c253.97a92",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "console.log(\"X-Cite-Exact>Request:\"+msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 1680,
        "wires": [
            [
                "799738c6.9b4b78"
            ]
        ]
    },
    {
        "id": "ad44600a.ee96c",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "X-CITE",
        "func": "\nif((msg.device === 'X-Cite-120PC') &&(msg.action === 'setOFF')){\n    msg.payload = 'zz';\n    return msg ;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 1620,
        "wires": [
            [
                "9cd5c253.97a92",
                "3d3cdd6e.cb3482"
            ]
        ],
        "icon": "node-red/camera.png"
    },
    {
        "id": "dd8d8104.2537c",
        "type": "serial out",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "serial": "8c22d0ce.65698",
        "x": 1070,
        "y": 1240,
        "wires": []
    },
    {
        "id": "2b15c60a.1c8aba",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Buzzer",
        "func": "if((msg.device === 'OLYMPUS-IX-81') && (msg.status.autofocus === 'ECHEC') ) node.send({\"payload\" : \"1\"});\nif((msg.device === 'OLYMPUS-IX-81') && (msg.status.autofocus === 'SUCCESS') ) node.send({\"payload\" : \"2\"});",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 1240,
        "wires": [
            [
                "dd8d8104.2537c"
            ]
        ]
    },
    {
        "id": "d57552ce.aaf4c",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "2",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 770,
        "y": 1300,
        "wires": [
            [
                "501f0a71.994124"
            ]
        ]
    },
    {
        "id": "501f0a71.994124",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 920,
        "y": 1300,
        "wires": [
            [
                "dd8d8104.2537c",
                "bdc037a5.fc8c88"
            ]
        ]
    },
    {
        "id": "a4154d19.31117",
        "type": "http in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "url": "/saveTest",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 340,
        "y": 2040,
        "wires": [
            [
                "9ebaa64e.107c78",
                "23e84143.312d2e",
                "f724392.d8e52c8"
            ]
        ]
    },
    {
        "id": "9ebaa64e.107c78",
        "type": "http response",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 520,
        "y": 2340,
        "wires": []
    },
    {
        "id": "23e84143.312d2e",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "context.global.saveMask ='saveMask:' + msg.payload.image;\nmsg.payload = 'saveMask:' + msg.payload.image ;\nreturn msg\n",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 2040,
        "wires": [
            [
                "3c184b5c.b38284"
            ]
        ]
    },
    {
        "id": "ac78ed0a.9787d",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "msg.payload = msg.payload.image.substr(7,msg.payload.image.length);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 2200,
        "wires": [
            [
                "3cf05be5.e6d774",
                "e32ba1f0.86128"
            ]
        ]
    },
    {
        "id": "3cf05be5.e6d774",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "C:\\Users\\labo\\customizeNode\\node-red-contrib-andor-mosaic3\\AndorMosaic3\\base64.txt",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1050,
        "y": 2140,
        "wires": [
            []
        ]
    },
    {
        "id": "65856728.c6d468",
        "type": "http in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "url": "/activateMask",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 330,
        "y": 2200,
        "wires": [
            [
                "ac78ed0a.9787d",
                "9ebaa64e.107c78"
            ]
        ]
    },
    {
        "id": "e32ba1f0.86128",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 800,
        "y": 2200,
        "wires": [
            [
                "56fc06de.1d41b8"
            ]
        ]
    },
    {
        "id": "56fc06de.1d41b8",
        "type": "exec",
        "z": "cfcb4c03.e7a76",
        "command": "python C:\\Users\\labo\\customizeNode\\node-red-contrib-andor-mosaic3\\AndorMosaic3\\convert.py",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "",
        "x": 1250,
        "y": 2200,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "e93e9872.51e7f8",
        "type": "http in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "url": "/desactivateMask",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 300,
        "y": 2280,
        "wires": [
            [
                "2d610a66.0832c6",
                "9ebaa64e.107c78"
            ]
        ]
    },
    {
        "id": "bb31a5c1.72d708",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "C:\\Users\\labo\\customizeNode\\node-red-contrib-andor-mosaic3\\AndorMosaic3\\mosaic_status.txt",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1230,
        "y": 2280,
        "wires": [
            []
        ]
    },
    {
        "id": "2d610a66.0832c6",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "var msg2 = {};\nmsg.payload = 'OFF';\nmsg2.payload = 'WAIT';\n\nreturn [msg,msg2];",
        "outputs": 2,
        "noerr": 0,
        "x": 630,
        "y": 2280,
        "wires": [
            [
                "93e8f7d7.fdafe8"
            ],
            [
                "d0e0ff12.f99ca"
            ]
        ]
    },
    {
        "id": "d0e0ff12.f99ca",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 780,
        "y": 2300,
        "wires": [
            [
                "bb31a5c1.72d708"
            ]
        ]
    },
    {
        "id": "93e8f7d7.fdafe8",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "0",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 780,
        "y": 2260,
        "wires": [
            [
                "bb31a5c1.72d708",
                "9b95dae4.3cccf8"
            ]
        ]
    },
    {
        "id": "bdc037a5.fc8c88",
        "type": "exec",
        "z": "cfcb4c03.e7a76",
        "command": " start \"google\" \"c:\\program files (x86)\\Google\\Chrome\\Application\\chrome.exe\" \"http://127.0.0.1:1880/missmarple\"",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "",
        "x": 1540,
        "y": 1300,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "f724392.d8e52c8",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Man",
        "func": "msg.payload = msg.payload.image.substr(22,msg.payload.image.length);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 2140,
        "wires": [
            [
                "3cf05be5.e6d774"
            ]
        ]
    },
    {
        "id": "3d3cdd6e.cb3482",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "X-CITE",
        "func": "if(msg.device === 'X-Cite-120PC'){\n    msg.device = 'X-Cite-120PC';\n    msg.topic = \"Fluorescence2\"; \nmsg.type = 'ligth-source' ; \n        msg.payload = 'done';\n    node.send(msg);\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1140,
        "y": 1620,
        "wires": [
            [
                "b6fa52b8.d4383"
            ]
        ],
        "icon": "node-red/camera.png"
    },
    {
        "id": "3c184b5c.b38284",
        "type": "websocket out",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "server": "a09da2d9.ae78a",
        "client": "",
        "x": 840,
        "y": 2040,
        "wires": []
    },
    {
        "id": "b2cf7e84.23adf",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Auto",
        "func": "if((msg.device === 'MOSAIC')&&(msg.action ==='EXP')){\n    msg.payload = msg.img.substr(7,msg.img.length);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 2080,
        "wires": [
            [
                "e32ba1f0.86128",
                "6b2ad3f1.177ecc",
                "3cf05be5.e6d774"
            ]
        ]
    },
    {
        "id": "219f6c0.715f494",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Auto",
        "func": "if((msg.device === 'MOSAIC')&&(msg.action ==='NEXP')){\n    msg.payload = 'done';   \n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 2240,
        "wires": [
            [
                "2d610a66.0832c6"
            ]
        ]
    },
    {
        "id": "6b2ad3f1.177ecc",
        "type": "delay",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 800,
        "y": 2080,
        "wires": [
            [
                "9b95dae4.3cccf8"
            ]
        ]
    },
    {
        "id": "9b95dae4.3cccf8",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Auto",
        "func": "\n    msg.payload ='done';\n    msg.topic = 'Mosaic';\n    msg.device = 'MOSAIC';\n    return msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 970,
        "y": 2080,
        "wires": [
            [
                "1a5a67ed.6b7d78"
            ]
        ]
    },
    {
        "id": "6fbb0648.ee4338",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "MF",
        "func": "if((msg.topic === 'MF')){\n    //node.log(msg);\n    node.status ({fill:\"green\",shape:\"dot\", text: \"send...\"});\n    if((context.global.nCell > parseInt(msg.update.value))&&(msg.update.cond === true)){\n        if((msg.update.v1===true)&&(context.global.lockValve1 === false)){\n            context.global.lockValve1 = true ;\n           context.global.graph1 = !context.global.graph1;\n           setTimeout(function(){\n                context.global.graph1 = !context.global.graph1;\n                //node.send({'payload' : new Date()});\n            },parseInt(msg.update.t1)*1000) ;\n        }\n        if((msg.update.v2===true)&&(context.global.lockValve2 === false)){\n           context.global.lockValve2 = true ;\n           context.global.graph2 = !context.global.graph2;\n           setTimeout(function(){\n                context.global.graph2 = !context.global.graph2;\n               // node.send({'payload' : new Date()});\n            },parseInt(msg.update.t2)*1000) ;\n        }\n        if((msg.update.v3===true)&&(context.global.lockValve3 === false)){\n           context.global.lockValve3 = true ;\n            context.global.graph3 = !context.global.graph3;\n            setTimeout(function(){\n                context.global.graph3 = !context.global.graph3;\n                //node.send({'payload' : new Date()});\n            },parseInt(msg.update.t3)*1000) ;\n        }\n        if((msg.update.v4===true)&&(context.global.lockValve4 === false)){\n           context.global.lockValve4 = true ;\n            context.global.graph4 = !context.global.graph4;\n            setTimeout(function(){\n                context.global.graph4 = !context.global.graph4;\n               // node.send({'payload' : new Date()});\n            },parseInt(msg.update.t4)*1000) ;\n        }\n        if((msg.update.v5===true)&&(context.global.lockValve5 === false)){\n           context.global.lockValve5 = true ;\n            context.global.graph5 = !context.global.graph5;\n            setTimeout(function(){\n                context.global.graph5 = !context.global.graph5;\n              //  node.send({'payload' : new Date()});\n            },parseInt(msg.update.t5)*1000) ;\n        }\n    \n    }\n   \n      setTimeout(function(){\n        var msg = {};\n        msg.topic = 'MF'\n        msg.payload = \"done\";\n        msg.action = 'MF';\n        msg.device = 'MF';\n        node.status ({fill:\"yellow\",shape:\"dot\", text: \"send...\"});\n        node.send(msg);\n    },1000)\n    \n}\n\n    ",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 640,
        "wires": [
            [
                "6be44e13.6e89f",
                "a2b9cf72.dd788"
            ]
        ]
    },
    {
        "id": "ac450fe5.3d12b",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": " context.global.lockValve = false;",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3670,
        "y": 800,
        "wires": [
            [
                "bc3d87ce.11eaa8"
            ]
        ]
    },
    {
        "id": "bc3d87ce.11eaa8",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": " context.global.lockValve1 = false;\n context.global.lockValve2 = false;\n context.global.lockValve3 = false;\n context.global.lockValve4 = false;\n context.global.lockValve5 = false;\n context.global.nCellStack = [];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3930,
        "y": 800,
        "wires": [
            []
        ]
    },
    {
        "id": "452e9b3f.620514",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": " context.global.nCell = 100;",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3650,
        "y": 840,
        "wires": [
            [
                "49621a4e.dbfec4"
            ]
        ]
    },
    {
        "id": "49621a4e.dbfec4",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": " context.global.nCell = 100;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3930,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "48cb4c42.114484",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": " context.global.nCell = 200;",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3650,
        "y": 760,
        "wires": [
            [
                "1c22049a.cc9fab"
            ]
        ]
    },
    {
        "id": "1c22049a.cc9fab",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": " context.global.nCell = 200;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3930,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "7c312d8d.8e5164",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 260,
        "y": 640,
        "wires": [
            [
                "e293f551.dbc308"
            ]
        ]
    },
    {
        "id": "e293f551.dbc308",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "msg.topic = 'MF';\nmsg.device = 'MF';\nmsg.update = {};\nmsg.update.v1 = true;\nmsg.update.v2 = true;\nmsg.update.v3 = true;\nmsg.update.v4 = true;\nmsg.update.v5 = true;\nmsg.update.cond = true;\nmsg.update.value = 150;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 640,
        "wires": [
            [
                "6fbb0648.ee4338"
            ]
        ]
    },
    {
        "id": "de93a0a.6d42c6",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "msg.payload = context.global.nCellStack;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3730,
        "y": 680,
        "wires": [
            [
                "48c1a099.d33dc"
            ]
        ]
    },
    {
        "id": "d1315246.b313a",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "Stack",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3590,
        "y": 680,
        "wires": [
            [
                "de93a0a.6d42c6"
            ]
        ]
    },
    {
        "id": "48c1a099.d33dc",
        "type": "debug",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "x": 3890,
        "y": 680,
        "wires": []
    },
    {
        "id": "383ffea5.0ab012",
        "type": "file",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "filename": "nCell.txt",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "x": 3920,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "98ff5f6e.27d95",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "func": "msg.payload = new Date() + \";\" + context.global.nCell;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3730,
        "y": 720,
        "wires": [
            [
                "383ffea5.0ab012"
            ]
        ]
    },
    {
        "id": "7953849a.de27fc",
        "type": "inject",
        "z": "cfcb4c03.e7a76",
        "name": "Stack",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 3590,
        "y": 720,
        "wires": [
            [
                "98ff5f6e.27d95"
            ]
        ]
    },
    {
        "id": "22a51e12.ba76a2",
        "type": "link in",
        "z": "cfcb4c03.e7a76",
        "name": "input_cam",
        "links": [
            "61e37720.8d9758"
        ],
        "x": 395,
        "y": 2080,
        "wires": [
            [
                "219f6c0.715f494",
                "b2cf7e84.23adf"
            ]
        ]
    },
    {
        "id": "1a5a67ed.6b7d78",
        "type": "link out",
        "z": "cfcb4c03.e7a76",
        "name": "seq1",
        "links": [
            "1a9a8b32.5d8bb5"
        ],
        "x": 1075,
        "y": 2080,
        "wires": []
    },
    {
        "id": "b6fa52b8.d4383",
        "type": "link out",
        "z": "cfcb4c03.e7a76",
        "name": "seq2",
        "links": [
            "1a9a8b32.5d8bb5"
        ],
        "x": 1255,
        "y": 1620,
        "wires": []
    },
    {
        "id": "1a9a8b32.5d8bb5",
        "type": "link in",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "links": [
            "1a5a67ed.6b7d78",
            "b6fa52b8.d4383"
        ],
        "x": 1095,
        "y": 580,
        "wires": [
            [
                "6be44e13.6e89f"
            ]
        ]
    },
    {
        "id": "a2b9cf72.dd788",
        "type": "debug",
        "z": "cfcb4c03.e7a76",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 1120,
        "y": 540,
        "wires": []
    },
    {
        "id": "55188d6c.2d6834",
        "type": "function",
        "z": "cfcb4c03.e7a76",
        "name": "Protocol 19022019a",
        "func": "var mda = msg.payload ;\nvar output = {} ;\n\ntry {\n    if(mda['type'] === 'mda'){\n       // if(mda.children[0].data.algo === 'algo1'){\n            try{\n                output = algo1(mda);\n            } catch(err){node.warn(\"ERRR\");}\n       // }\n        msg.payload = \"MDA-START\" ;\n        context.global.sequence2 = output ;\n        context.global.lockValve1 = false ;\n        context.global.lockValve2 = false ;\n        context.global.lockValve3 = false ;\n        context.global.lockValve4 = false ;\n        context.global.lockValve5 = false ;\n\n        context.global.nCell = -1 ;\n        context.global.nCellStack = [] ;\n        return msg;   \n    }\n   \n}\ncatch(error){}\n\nfunction algo1(mda){\n    \n    var test = {} ;\n    /*Algo 1\n    sequence\n    ----position\n        ----light\n        ----zs ou camera\n        ----light\n        ----zs ou came\n            ....\n    ----position\n        ....\n    */    \n    \n   \n    \n            \n    //repeat sequence\n        for(var i=0; i<parseInt(mda.children[0].children[0].data.repeat);i++){\n            test[String(i*parseInt(mda.children[0].children[0].data.time))] = [] ;\n\n\n\n\n        if(i===0){\n             //BF initialisation car long pour l'instant papramètres statiques\n                /*\n                inject = [];\n                inject.push({\n                    'topic' : 'Microscope1',\n                    'device' : 'OLYMPUS-IX-81',\n                    'action' : 'setChannel',\n                    'mode' : 'MDA',\n                    'update' : {\n                        'lamp' : true,\n                        'intensity':  2,\n                        'shutter': false,\n                        'keep' : false ,\n                        'timeout' : -1///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time)\n                    } \n                });\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                */\n                \n                \n                for(var l=1; l<context.global.settingChannels.length; l++){\n//                    if(context.global.settingChannels[l].name === mda.children[0].children[0].children[ii].children[iii].data.title2){\n//                        var exposure = -1 ;\n                        inject = [];\n                        //BF\n                        if(context.global.settingChannels[l].device === \"OLYMPUS-IX-81\"){\n                            device = context.global.settingChannels[l].device ;\n                            topic = context.global.settingChannels[l].topic ;\n                            inject.push({\n                                'topic' : context.global.settingChannels[l].topic,\n                                'device' : context.global.settingChannels[l].device,\n                                'action' : 'setChannel',\n                                'mode' : 'MDA',\n                                'update' : {\n                                    'lamp' : true,\n                                    'intensity': (context.global.settingChannels[l].update.A[0]),\n                                    'shutter': false,\n                                    'keep' : false ,\n                                    'timeout' : -1///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time)\n                                } \n                            });\n                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                        }\n//                    }\n                }\n                \n                \n                //temporisation\n                inject = [];\n                inject.push({\n                    'topic' : 'f_tempo',\n                    'device' : 'none',\n                    'action' : 'f_tempo',\n                    'update' : {\n                        't' : 1000\n                    }\n                });\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n        }\n                \n            //position\n            for(var ii=0; ii<mda.children[0].children[0].children.length;ii++){\n                var titlePisition = mda.children[0].children[0].children[ii].title ;\n                var inject = [] ;           \n                  var q = 1;\n                  //go to position x et y \n                inject.push({\n                    'payload' :  context.global.MotionStage1,\n                    'topic' : 'MotionStage1',\n                    'device' :  context.global.MotionStage1,\n                    'mode' : 'MDA',\n                    'action' : 'set',\n                    'update' : {\n                        \"xPosition\" : parseInt(mda.children[0].children[0].children[ii].data.xPosition),\n                        \"yPosition\" : parseInt(mda.children[0].children[0].children[ii].data.yPosition),\n                        \"moveType\" : \"G\"\n                        }\n                    });\n                //go to z position\n                /*inject.push({\n                    'topic' : 'Microscope1',\n                    'device' : context.global.Microscope1,\n                    'action' : 'setZPosition',\n                    'mode' : 'MDA',\n                    'update' : {\n                        'zPosition': parseInt(mda.children[0].children[0].children[ii].data.zPosition),\n                        }\n                    });\n                */\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                //in the position\n                \n                for(var iii=0; iii<mda.children[0].children[0].children[ii].children.length;iii++){\n                    //filter\n                    var zstart = 0;\n                    var zend = 0;\n                    var zstep = 0;\n                          \n                    var limit = 1 ;\n                    //var af = false ; \n                    var keep = false ;\n                    var zPosition =parseInt(mda.children[0].children[0].children[ii].data.zPosition);\n                    var active = 0 ;\n////MF CONDITIONNEL\n                    if(mda.children[0].children[0].children[ii].children[iii].type === 'MF'){\n                        //af = true ;\n                       inject = [] ;\n                        inject.push({\n                            'topic' : 'MF',\n                            'device' : 'MF',\n                            'action' : 'MF',\n                            'update' : {\n                                \"v1\": mda.children[0].children[0].children[ii].children[iii].data.v1,\n                                \"v2\": mda.children[0].children[0].children[ii].children[iii].data.v2,\n                                \"v3\": mda.children[0].children[0].children[ii].children[iii].data.v3,\n                                \"v4\": mda.children[0].children[0].children[ii].children[iii].data.v4,\n                                \"v5\": mda.children[0].children[0].children[ii].children[iii].data.v5,\n                                \"t1\": mda.children[0].children[0].children[ii].children[iii].data.t1,\n                                \"t2\": mda.children[0].children[0].children[ii].children[iii].data.t2,\n                                \"t3\": mda.children[0].children[0].children[ii].children[iii].data.t3,\n                                \"t4\": mda.children[0].children[0].children[ii].children[iii].data.t4,\n                                \"t5\": mda.children[0].children[0].children[ii].children[iii].data.t5,\n                                \"cond\" : mda.children[0].children[0].children[ii].children[iii].data.cond,\n                                \"value\":mda.children[0].children[0].children[ii].children[iii].data.value\n                                \n                            }\n                            });\n                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                       /* inject = [];\n                                            inject.push({\n                                                'topic' : 'MF',\n                                                'device' : 'MF',\n                                                'action' : 'MF',\n                                                'update' : {\n                                                    't' : 10000\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);*/\n                    \n                    }\n\n////\n\n                    if(mda.children[0].children[0].children[ii].children[iii].type === 'AF'){\n                        //af = true ;\n                        inject = [] ;\n                        inject.push({\n                            'topic' : 'Microscope1',\n                            'device' : context.global.Microscope1,\n                            'action' : 'af',\n                            'mode' : 'MDA',\n                            'update' : {\n                                \"farLimit\" : 1,\n                                \"nearLimit\" : 3000000,\n                                \"affLimit\": parseInt(mda.children[0].children[0].children[ii].children[iii].data.zPosition)-(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.lower)),\n                                \"afnLimit\": parseInt(mda.children[0].children[0].children[ii].children[iii].data.zPosition)+(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.upper)),\n                                \"objective\": parseInt(mda.children[0].children[0].children[ii].children[iii].data.n),\n                                \"offset\" : parseInt(mda.children[0].children[0].children[ii].children[iii].data.zOffset)\n                                }\n                            });\n                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                    \n                    }\n                    if((mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT')){\n                  \n                    \n                                  /*  if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                    if(( q !== 0)){\n                       //          node.warn(i+'-'+parseInt(mda.children[0].children[0].children[ii].children[iii].data.skip)+'-'+ (i+1)%parseInt(mda.children[0].children[0].children[ii].children[iii].data.skip) );\n                        /************************ remove wh\n                        inject = [] ;\n                        inject.push({\n                            'topic' : 'Microscope1',\n                            'device' : context.global.Microscope1,\n                            'action' : 'setWheelFilter',\n                            'mode' : 'MDA',\n                            'update':{\n                                'wheelFilter': parseInt(mda.children[0].children[0].children[ii].children[iii].data.wheel)\n                                }\n                            });\n                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                        *////////////////////////// remove wh \n                        // detect image or zstack AND set limit for the repeat loop\n                        if(mda.children[0].children[0].children[ii].children[iii+1].type === 'CAMERA'){\n                            limit = 1 ;\n                            keep = false ;\n                            active = 0 ;\n                        }\n                        if(mda.children[0].children[0].children[ii].children[iii+1].type === 'ZS'){\n                            zstart = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zstart);\n                            zend = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zend);\n                            zstep = parseInt(mda.children[0].children[0].children[ii].children[iii+1].data.zstep);\n                            progress = parseInt(Math.abs(zstart-zend) / zstep) + 1 ;\n                            limit = progress ;\n                            keep = mda.children[0].children[0].children[ii].children[iii+1].data.shutter ;\n                            active = 1 ;\n                        }\n                    }\n                    }\n                        \n                    if(true) {\n//                        node.warn(\"limit:\"+limit);\n                        for(var r=0;r<limit;r++){\n                            \n                            if(r===limit-1) keep = false ;\n                            inject = [] ;\n                            var a  = (zPosition + active * 100*(zstart + zstep * r));\n                            \n                            \n                            //if(mda.children[0].children[0].children[ii].children[iii].type !== 'AF'){\n                                inject.push({\n                                    'topic' : 'Microscope1',\n                                    'device' : context.global.Microscope1,\n                                    'action' : 'setZPosition',\n                                    'mode' : 'MDA',\n                                    'update' : {\n                                        'zPosition': a,\n                                        'moveType' : 'd'\n                                        }\n                                    });\n                            //}\n                           if(mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'){\n                            \n                                  /*  if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                    if(( q !== 0)){\n                          try{\n                                    if((mda.children[0].children[0].children[ii].children[iii-1].type !== 'AF')){\n                                        //if((mda.children[0].children[0].children[ii].children[iii-1].type !== 'MOSAIC'))\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    }\n                                    if((mda.children[0].children[0].children[ii].children[iii+1].type === 'ZS')){\n                                        //if((mda.children[0].children[0].children[ii].children[iii-1].type !== 'MOSAIC'))\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    }\n                                }\n                                catch(error){\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                }\n                    }\n                        }\n                                \n                            //AF\n                           /* if(mda.children[0].children[0].children[ii].children[iii].type === 'AF'){\n                                af = true ;\n                                inject = [] ;\n                                inject.push({\n                                    'topic' : 'Microscope1',\n                                    'device' : context.global.Microscope1,\n                                    'action' : 'af',\n                                    'mode' : 'MDA',\n                                    'update' : {\n                                        \"farLimit\" : 1,\n                                        \"nearLimit\" : 3000000,\n                                        \"affLimit\": zPosition-(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.lower)),\n                                        \"afnLimit\": zPosition+(100*parseInt(mda.children[0].children[0].children[ii].children[iii].data.upper)),\n                                        \"objective\": 30,\n                                        \"offset\" : parseInt(mda.children[0].children[0].children[ii].children[iii].data.zOffset)\n                                        }\n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                            \n                           }*/\n           \n           \n                   \n        \n                            //set Ligth\n                            if(((mda.children[0].children[0].children[ii].children[iii].type === 'LIGHT'))){\n                                \n                                /*\n                                    if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                    if(( q !== 0)){\n                      \n                                var device ;var topic ;\n                                for(var l=1; l<context.global.settingChannels.length; l++){\n                                    if(context.global.settingChannels[l].name === mda.children[0].children[0].children[ii].children[iii].data.title2){\n                                     \n                                        var exposure = -1 ;\n                                        inject = [];\n                                        //BF\n                                        var titleChannel = mda.children[0].children[0].children[ii].children[iii].data.title2 ;\n                                        if(context.global.settingChannels[l].device === \"OLYMPUS-IX-81\"){\n                                              /********** ajout wh\n                                             */\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : 'Microscope1',\n                                                'device' : context.global.Microscope1,\n                                                'action' : 'setWheelFilter',\n                                                'mode' : 'MDA',\n                                                'update':{\n                                                    'wheelFilter': parseInt(context.global.settingChannels[l].update.C[0])\n                                                    }\n                                                });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            inject = [];\n                                            inject.push({\n                                                'topic' : 'f_tempo',\n                                                'device' : 'none',\n                                                'action' : 'f_tempo',\n                                                'update' : {\n                                                    't' : 2500\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            /********/\n                                            device = context.global.settingChannels[l].device ;\n                                            topic = context.global.settingChannels[l].topic ;\n                                             inject = [] ;\n                                             inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    'lamp' : true,\n                                                    'intensity': (context.global.settingChannels[l].update.A[0]),\n                                                    'shutter': true,\n                                                    'keep' : keep ,\n                                                    'timeout' : -1///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time)\n                                                } \n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            //exposure = 200; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                        //COOLLED\n                                        if(context.global.settingChannels[l].device === \"CoolLed-PE4000\"){\n                                            /********** ajout wh\n                                             */\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : 'Microscope1',\n                                                'device' : context.global.Microscope1,\n                                                'action' : 'setWheelFilter',\n                                                'mode' : 'MDA',\n                                                'update':{\n                                                    'wheelFilter': parseInt(context.global.settingChannels[l].update.F[0])\n                                                    }\n                                                });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            inject = [];\n                                            inject.push({\n                                                'topic' : 'f_tempo',\n                                                'device' : 'none',\n                                                'action' : 'f_tempo',\n                                                'update' : {\n                                                    't' : 2500\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            /********/\n                                            device = context.global.settingChannels[l].device ;\n                                            topic = context.global.settingChannels[l].topic ;\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    \"A\" :[parseInt(context.global.settingChannels[l].update.A[0]),parseInt(context.global.settingChannels[l].update.A[1]),context.global.settingChannels[l].update.A[2] == \"ON\" ? true : false],\n                                                    \"B\" :[parseInt(context.global.settingChannels[l].update.B[0]),parseInt(context.global.settingChannels[l].update.B[1]),context.global.settingChannels[l].update.B[2] == \"ON\" ? true : false],\n                                                    \"C\" :[parseInt(context.global.settingChannels[l].update.C[0]),parseInt(context.global.settingChannels[l].update.C[1]),context.global.settingChannels[l].update.C[2] == \"ON\" ? true : false],\n                                                    \"D\" :[parseInt(context.global.settingChannels[l].update.D[0]),parseInt(context.global.settingChannels[l].update.D[1]),context.global.settingChannels[l].update.D[2] == \"ON\" ? true : false],\n                                                    'timeout' : -1,///parseInt(mda.children[0].children[0].children[ii].children[iii].data.time),\n                                                    'keep': keep\n                                                    }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            //exposure = 100; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                        //x-cite\n                                        var intxcite = parseInt(context.global.settingChannels[l].update.A[0]) ;\n                                        if(context.global.settingChannels[l].device === \"X-Cite-120PC\"){\n                                             /********** ajout wh\n                                             */\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : 'Microscope1',\n                                                'device' : context.global.Microscope1,\n                                                'action' : 'setWheelFilter',\n                                                'mode' : 'MDA',\n                                                'update':{\n                                                    'wheelFilter': parseInt(context.global.settingChannels[l].update.C[0])\n                                                    }\n                                                });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            inject = [];\n                                            inject.push({\n                                                'topic' : 'f_tempo',\n                                                'device' : 'none',\n                                                'action' : 'f_tempo',\n                                                'update' : {\n                                                    't' : 2500\n                                                }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            /********/\n                                            device = context.global.settingChannels[l].device ;\n                                            topic = context.global.settingChannels[l].topic ;\n                                            inject = [] ;\n                                            inject.push({\n                                                'topic' : context.global.settingChannels[l].topic,\n                                                'device' : context.global.settingChannels[l].device,\n                                                'action' : 'setChannel',\n                                                'mode' : 'MDA',\n                                                'update' : {\n                                                    \"A\" :[parseInt(context.global.settingChannels[l].update.A[0]),true]\n                                                    }\n                                            });\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            //exposure = 100; //\n                                            exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                        }\n                                        \n                                    }\n                                }\n                            }}\n                            if(mda.children[0].children[0].children[ii].children[iii].type === 'MOSAIC'){\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Mosaic',\n                                    'device' : 'MOSAIC',\n                                    'action' : 'EXP',\n                                    'img' :  mda.children[0].children[0].children[ii].children[iii].data.image\n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                             \n                            }\n                            if(mda.children[0].children[0].children[ii].children[iii].type === 'NMOSAIC'){\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Mosaic',\n                                    'device' : 'MOSAIC',\n                                    'action' : 'NEXP',\n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                             \n                            }\n                            if((mda.children[0].children[0].children[ii].children[iii].type === 'CAMERA')){\n                            /*\n                             \n                                    if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                    if(( q !== 0)){\n                      \n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Camera1',\n                                    'device' : context.global.Camera1,\n                                    'action' : 'GRAB',\n                                    'prefixe' : mda.children[0].data.prefixe,\n                                    'channel': titleChannel,\n                                    'position' : titlePisition,  \n                                    'exposure' : exposure \n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                             \n                                inject = [];\n                                if(device === \"OLYMPUS-IX-81\"){\n                                    inject.push({\n                                        'topic' : topic,\n                                        'device' : device,\n                                        'action' : 'setOFF'\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    //exposure = 200; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                } \n                                \n                                if(device === \"CoolLed-PE4000\"){\n                                    inject.push({\n                                        'topic' : topic,\n                                        'device' : device,\n                                        'action' : 'setOFF'\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    //exposure = 100; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                if(device === \"X-Cite-120PC\"){\n                                    inject.push({\n                                        'device' : device ,\n                                            'topic' : topic ,\n                                            'action' : 'setChannel',\n                                            'mode' : 'MDA',\n                                            'update' : {\n                                                \"A\" :[intxcite,false]\n                                                }\n                                        });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    //exposure = 100; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                \n                                //a régler dynamiquement\n                                inject = [];\n                                inject.push({\n                                    'topic' : 'f_tempo',\n                                    'device' : 'none',\n                                    'action' : 'f_tempo',\n                                    'update' : {\n                                        't' : 600\n                                    }\n                                });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                            \n                                \n                                \n                               /* if(exposure !== -1){\n                                    if(ii!==mda.children[0].children[0].children.length-1){\n                                            inject = [];\n                                            inject.push({'action' : '_waiting_',});\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = -1 ;\n                                        }\n                                }*/\n\n                            }\n                            }\n                            if((limit > 1)&&(mda.children[0].children[0].children[ii].children[iii].type !== 'ZS')){\n                            /*\n                                    if(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip!==0))\n                                        q = (i+1)%(parseInt(mda.children[0].children[0].children[ii].children[iii-1].data.skip)) ;\n                                    else\n                                        q = 1 ;*/\n                                \n                                if(( q !== 0)){\n                      \n                                inject = [];\n                                inject.push({\n                                    'topic' : 'Camera1',\n                                    'device' : context.global.Camera1,\n                                    'action' : 'GRAB',\n                                    'prefixe' : mda.children[0].data.prefixe,\n                                    'channel': titleChannel,\n                                    'position' : titlePisition,  \n                                    'exposure' : exposure \n                                    });\n                                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                \n                                \n                                \n                                /*\n                                here shutter close during the z-stack\n                                */\n                                \n                                if(r===limit-1){ \n                                    inject = [];\n                                    if(device === \"OLYMPUS-IX-81\"){\n                                        inject.push({\n                                            'topic' : topic,\n                                            'device' : device,\n                                            'action' : 'setOFF'\n                                        });\n                                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                        //exposure = 200; //\n                                        //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                    } \n                                    \n                                    if(device === \"CoolLed-PE4000\"){\n                                        inject.push({\n                                            'topic' : topic,\n                                            'device' : device,\n                                            'action' : 'setOFF'\n                                        });\n                                        test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                        //exposure = 100; //\n                                        //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                    }\n\n                                    if(device === \"X-Cite-120PC\"){\n                                    inject.push({\n                                        'device' : device ,\n                                            'topic' : topic ,\n                                            'action' : 'setChannel',\n                                            'mode' : 'MDA',\n                                            'update' : {\n                                                \"A\" :[intxcite,\"OFF\"]\n                                                }\n                                        });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n\n                                    //a régler dynamiquement\n                                    inject = [];\n                                    inject.push({\n                                        'topic' : 'f_tempo',\n                                        'device' : 'none',\n                                        'action' : 'f_tempo',\n                                        'update' : {\n                                            't' : 300\n                                        }\n                                    });\n                                    test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                    \n                                    //exposure = 100; //\n                                    //exposure = parseInt(mda.children[0].children[0].children[ii].children[iii].data.time);//parseInt(mda.children[0].children[0].children[ii].children[iii].data.time) ;\n                                }\n                                }\n                                \n                                /*if(exposure !== -1){\n                                    if(ii!==mda.children[0].children[0].children.length-1){\n                                            inject = [];\n                                            inject.push({'action' : '_waiting_'});\n                                            test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n                                            exposure = -1 ;\n                                        }\n                                }*/\n                            }}\n                        \n                        }\n                    }\n                }\n            }\n        \n            if(i === parseInt(mda.children[0].children[0].data.repeat)-1){\n                inject =[{'payload' : 'MDA-FINISH'}];\n                test[String(i*parseInt(mda.children[0].children[0].data.time))].push(inject);\n            }            \n        }\n        return test ;    \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2600,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "a09da2d9.ae78a",
        "type": "websocket-listener",
        "z": "",
        "path": "/ws/missmarple",
        "wholemsg": "false"
    },
    {
        "id": "57d0174f.790978",
        "type": "websocket-listener",
        "z": "",
        "path": "/publishEVOLV512",
        "wholemsg": "false"
    },
    {
        "id": "3a7ea16c.f1526e",
        "type": "websocket-listener",
        "z": "",
        "path": "/receiveEVOLV512",
        "wholemsg": "false"
    },
    {
        "id": "4c492437.085a0c",
        "type": "serial-port",
        "z": "",
        "serialport": "COM22",
        "serialbaud": "9600",
        "databits": "8",
        "parity": "none",
        "stopbits": "1",
        "newline": "0x0d",
        "bin": "false",
        "out": "char",
        "addchar": true,
        "responsetimeout": "10000"
    },
    {
        "id": "8c22d0ce.65698",
        "type": "serial-port",
        "z": "",
        "serialport": "COM6",
        "serialbaud": "9600",
        "databits": "8",
        "parity": "none",
        "stopbits": "1",
        "newline": "\\n",
        "bin": "false",
        "out": "char",
        "addchar": true,
        "responsetimeout": "10000"
    }
]